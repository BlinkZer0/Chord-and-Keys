<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chord & Scale Library</title>
  <!-- Tailwind (CDN) for the same look/feel as your TSX version -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tone.js for audio playback -->
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
</head>
<body class="min-h-screen w-full bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold">Chord & Scale Library</h1>
      <div class="text-xs text-slate-400">Audio starts on first click • Tone.js</div>
    </header>

    <!-- ============ 1) Choose What To Explore ============ -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold text-slate-100 mb-2">1) Choose What To Explore</h2>
      <div class="bg-slate-800/60 rounded-2xl p-4 border border-slate-700">
        <div class="flex flex-wrap gap-3 items-center">
          <div class="inline-flex rounded-xl overflow-hidden border border-slate-700">
            <button id="btnModeChord" class="px-3 py-2 text-sm bg-slate-700/70">Chord</button>
            <button id="btnModeScale" class="px-3 py-2 text-sm bg-slate-800/60 hover:bg-slate-700/50">Scale/Mode</button>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-300">System</label>
            <select id="selSystem" class="bg-slate-800/80 border border-slate-700 rounded-lg px-2 py-1"></select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-300">Key / Root</label>
            <select id="selKey" class="bg-slate-800/80 border border-slate-700 rounded-lg px-2 py-1"></select>
            <span id="badgeRoot" class="px-2 py-0.5 rounded-full text-xs font-semibold border bg-emerald-600/20 text-emerald-300 border-emerald-600/40"></span>
          </div>

          <div id="wrapChord" class="flex items-center gap-2">
            <label class="text-sm text-slate-300">Quality</label>
            <select id="selQuality" class="bg-slate-800/80 border border-slate-700 rounded-lg px-2 py-1"></select>
            <span id="badgeChordNotes" class="px-2 py-0.5 rounded-full text-xs font-semibold border bg-slate-700/40 text-slate-300 border-slate-600"></span>
          </div>

          <div id="wrapScale" class="hidden items-center gap-2">
            <label class="text-sm text-slate-300">Mode</label>
            <select id="selMode" class="bg-slate-800/80 border border-slate-700 rounded-lg px-2 py-1"></select>
            <span id="badgeScaleNotes" class="px-2 py-0.5 rounded-full text-xs font-semibold border bg-slate-700/40 text-slate-300 border-slate-600"></span>
          </div>

          <div class="flex items-center gap-2 ml-auto">
            <label class="text-sm text-slate-300">Instrument</label>
            <select id="selInstr" class="bg-slate-800/80 border border-slate-700 rounded-lg px-2 py-1"></select>
            <label class="text-sm text-slate-300">Tempo</label>
            <input id="tempo" type="number" class="w-20 bg-slate-800/80 border border-slate-700 rounded-lg px-2 py-1" value="110" />
          </div>
        </div>
      </div>
    </section>

    <!-- ============ 2) Visualize On Your Instrument ============ -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold text-slate-100 mb-2">2) Visualize On Your Instrument</h2>
      <div class="bg-slate-800/60 rounded-2xl p-4 border border-slate-700 space-y-6">
        <div id="pianoHost"></div>
        <div id="guitarHost" class="hidden"></div>
        <div id="bassHost" class="hidden"></div>
        <div id="violinHost" class="hidden"></div>
        <div id="fluteHost" class="hidden"></div>
        <div id="recorderHost" class="hidden"></div>
        <div id="trumpetHost" class="hidden"></div>
        <div id="saxophoneHost" class="hidden"></div>
        <div id="kotoHost" class="hidden"></div>
        <div id="neyHost" class="hidden"></div>

        <div class="flex items-center gap-2 pt-1">
          <span id="badgeId" class="px-2 py-0.5 rounded-full text-xs font-semibold border bg-slate-700/40 text-slate-300 border-slate-600">Selection: —</span>
          <span id="badgeSelNotes" class="px-2 py-0.5 rounded-full text-xs font-semibold border bg-slate-700/40 text-slate-300 border-slate-600">Notes: —</span>
          <button id="btnClearSel" class="px-2 py-1 text-xs font-semibold rounded-lg border bg-slate-700/40 text-slate-300 border-slate-600 hover:bg-slate-700/60">Clear Selection</button>
          <span class="text-xs text-slate-400">Tip: hold keys to play • <span class="font-semibold">Shift+click</span> toggles selection</span>
        </div>
      </div>
    </section>

    <!-- ============ 3) Listen ============ -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold text-slate-100 mb-2">3) Listen</h2>
      <div class="bg-slate-800/60 rounded-2xl p-4 border border-slate-700">
        <div id="listenChord" class="flex flex-wrap gap-3 items-center">
          <button id="btnPlayBlock" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold">Play Chord (block)</button>
          <button id="btnPlayArp" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold">Arpeggiate</button>
          <button id="btnPlayStrum" class="px-4 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 text-white font-semibold hidden">Strum (low→high)</button>
          <div class="text-sm text-slate-400">First click activates audio.</div>
        </div>
        <div id="listenScale" class="hidden items-center gap-3">
          <button id="btnPlayScale" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold">Play Scale (asc.)</button>
          <div class="text-sm text-slate-400">Plays two octaves from the tonic.</div>
        </div>
        <div id="listenSel" class="mt-4 flex flex-wrap gap-3 items-center">
          <button id="btnPlaySelChord" disabled class="px-4 py-2 rounded-xl bg-teal-600 hover:bg-teal-500 text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed">Play Selection (chord)</button>
          <button id="btnPlaySelArp" disabled class="px-4 py-2 rounded-xl bg-cyan-600 hover:bg-cyan-500 text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed">Play Selection (arp)</button>
        </div>
        <div class="mt-4 flex items-center gap-2">
          <input id="heldSustainSnap" type="checkbox" class="h-4 w-4" checked>
          <label for="heldSustainSnap" class="text-sm text-slate-300">Snap held note sustain to 1/16 note</label>
        </div>
      </div>
    </section>

    <!-- ============ 4) Export (de‑emphasized) ============ -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold text-slate-100 mb-2">4) Export (FL Studio)</h2>
      <div class="bg-slate-800/60 rounded-2xl p-4 border border-slate-700">
        <div class="flex flex-wrap gap-3 items-start">
          <button id="btnCopyFL" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-semibold">Copy for FL Paste (Score)</button>
          <button id="btnCopyCSV" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-semibold">Copy CSV</button>
          <button id="btnMid" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-semibold">Download .MID</button>
          <div class="text-xs text-slate-400">Browsers often block non‑text clipboard formats. If FL’s Paste is disabled after copying, use <span class="font-semibold">Download .MID</span> and drag into Piano Roll.</div>
        </div>
        <div id="copyStatus" class="text-xs text-slate-300 mt-2"></div>
      </div>
    </section>

    <!-- ============ Tests ============ -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold text-slate-100 mb-2">Automated Self‑Tests (dev)</h2>
      <div id="tests" class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"></div>
    </section>

      <footer class="mt-10 text-center text-xs text-slate-500">© 2025 — Interactive Chord & Scale Library</footer>
  </div>

<script>
// ========================= UTIL: THEORY =========================
// Quarter‑tone pitch map (0.5‑semitone steps = 24 pitch classes)
const NOTES_SHARP = [
  "C","C+","C#","C#+","D","D+","D#","D#+",
  "E","E+","F","F+","F#","F#+","G","G+",
  "G#","G#+","A","A+","A#","A#+","B","B+"
];
const PITCH_STEP = 0.5; // smallest interval in semitones
const OCTAVE = 12;      // semitones per octave
const ENHARMONIC_MAP = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#","E#":"F","B#":"C","Fb":"E","Cb":"B"};
const KEYS = ["C","C#","Db","D","D#","Eb","E","F","F#","Gb","G","G#","Ab","A","A#","Bb","B"];
const INSTRUMENTS = [
  "Piano",
  "Guitar",
  "Bass",
  "Violin",
  "Flute",
  "Recorder",
  "Trumpet",
  "Saxophone",
  "Koto",
  "Oud",
  "Ney",
  "Hammond Organ"
];
// Modes and scales. Quarter‑tone maqam patterns based on MaqamWorld theory (https://www.maqamworld.com/)
const MODES = {
  Ionian: [0,2,4,5,7,9,11],
  Dorian: [0,2,3,5,7,9,10],
  Phrygian: [0,1,3,5,7,8,10],
  Lydian: [0,2,4,6,7,9,11],
  Mixolydian: [0,2,4,5,7,9,10],
  Aeolian: [0,2,3,5,7,8,10],
  Locrian: [0,1,3,5,6,8,10],
  "Major Pentatonic": [0,2,4,7,9],
  "Minor Pentatonic": [0,3,5,7,10],
  Blues: [0,3,5,6,7,10],
  // Common maqamat using 24-TET intervals (0.5 = quarter-tone)
  "Maqam Rast": [0,2,3.5,5,7,9,10.5],      // Rast: E half-flat, B half-flat
  "Maqam Bayati": [0,1.5,3,5,7,8.5,10],    // Bayati: D half-flat, B half-flat
  "Maqam Hijaz": [0,1,4,5,7,8,11],         // Hijaz: augmented second between 2nd & 3rd
  "Maqam Saba": [0,1.5,3,4.5,7,8.5,10],    // Saba: D & F half-flat
  "Maqam Nahawand": [0,2,3,5,7,8,10]       // Nahawand: natural minor
};
// Group modes by musical system for UI filtering
const MODE_SYSTEMS = {
  Western: [
    "Ionian","Dorian","Phrygian","Lydian","Mixolydian","Aeolian","Locrian",
    "Major Pentatonic","Minor Pentatonic","Blues"
  ],
  Maqam: ["Maqam Rast","Maqam Bayati","Maqam Hijaz","Maqam Saba","Maqam Nahawand"]
};
const CHORD_QUALITIES = { Maj:[0,4,7], Min:[0,3,7], Dim:[0,3,6], Aug:[0,4,8], Sus2:[0,2,7], Sus4:[0,5,7], "7":[0,4,7,10], Maj7:[0,4,7,11], Min7:[0,3,7,10], m7b5:[0,3,6,10], Dim7:[0,3,6,9] };
function toSharpName(n){ return ENHARMONIC_MAP[n]||n; }
function pcIndex(note){
  const n = String(note).trim();
  const m = n.match(/^([A-G])([#b+-]*)/);
  if(!m) return null;
  const BASE = {C:0, D:2, E:4, F:5, G:7, A:9, B:11};
  let val = BASE[m[1]];
  for(const ch of (m[2]||"")){
    if(ch==="#") val += 1;
    else if(ch==="b") val -= 1;
    else if(ch==="+") val += PITCH_STEP;
    else if(ch==="-") val -= PITCH_STEP;
  }
  return val;
}
function pcName(i){
  const norm = ((i % OCTAVE) + OCTAVE) % OCTAVE;
  const idx = Math.round(norm / PITCH_STEP) % NOTES_SHARP.length;
  return NOTES_SHARP[idx];
}
function midiFrom(note, octave=4){
  const i = pcIndex(note);
  if(i==null) return null;
  return OCTAVE*(octave+1)+i;
}
function buildScale(tonic, modeName){ const rootPc=pcIndex(tonic); const pattern = MODES[modeName]||MODES.Ionian; if(rootPc==null) return []; return pattern.map(iv=> pcName(rootPc + iv)); }
function buildChord(root, quality){ const rootPc=pcIndex(root); const pattern = CHORD_QUALITIES[quality]||CHORD_QUALITIES.Maj; if(rootPc==null) return []; return pattern.map(iv=> pcName(rootPc + iv)); }
function makePcSet(notes){ return new Set(notes.map(pcIndex).filter(x=>x!=null)); }
function mod(n,m){ return ((n % m) + m) % m; }
function chordToMidi(notes, root, baseOct=4){
  const rootMidi = midiFrom(root, baseOct);
  if(rootMidi==null) return [];
  const rootPc = pcIndex(root);
  if(rootPc==null) return [];
  const pcs = notes.map(pcIndex).filter(x=>x!=null);
  const ordered = pcs.map(pc=>{
    let best = rootMidi - mod(rootPc - pc, OCTAVE);
    while(best < rootMidi-5) best += OCTAVE;
    while(best > rootMidi+OCTAVE) best -= OCTAVE;
    return best;
  }).sort((a,b)=>a-b);
  return Array.from(new Set(ordered));
}
function scaleToMidi(scaleNotes, tonic, startOct=4){
  const pcs = scaleNotes.map(pcIndex).filter(x=>x!=null);
  const tonicPc = pcIndex(tonic);
  if(tonicPc==null) return [];
  const seq = [];
  for(let o=startOct; o<=startOct+1; o++){
    for(const pc of pcs){ seq.push(OCTAVE*(o+1)+pc); }
  }
  const startIdx = pcs.indexOf(tonicPc);
  if(startIdx>0){
    const perOct = pcs.length;
    const out=[];
    for(let i=0;i<seq.length;i+=perOct){
      const chunk=seq.slice(i,i+perOct);
      out.push(...chunk.slice(startIdx), ...chunk.slice(0,startIdx));
    }
    return out;
  }
  return seq;
}

// Identify chord from selection
const CHORD_DICT = CHORD_QUALITIES; // reuse
function eqArr(a,b){ return a.length===b.length && a.every((v,i)=>v===b[i]); }
function intersection(a,b){ return a.filter(x=>b.includes(x)); }
function invOf(midiNotes, rootPc){ const bass=Math.min(...midiNotes); const d=mod((bass%OCTAVE)-rootPc,OCTAVE); if(Math.abs(d)<PITCH_STEP/2) return "root position"; if(Math.abs(d-3)<PITCH_STEP/2 || Math.abs(d-4)<PITCH_STEP/2) return "1st inv"; if(Math.abs(d-7)<PITCH_STEP/2 || Math.abs(d-8)<PITCH_STEP/2 || Math.abs(d-6)<PITCH_STEP/2) return "2nd inv"; return "inversion"; }
function chordNameFromNotes(midiNotes){ if(!midiNotes.length) return {name:"—",detail:""}; const pcs=[...new Set(midiNotes.map(n=>mod(n,OCTAVE)))].sort((a,b)=>a-b); let best=null; for(const root of pcs){ const trans=pcs.map(pc=> mod(pc-root,OCTAVE)).sort((a,b)=>a-b); for(const [qual,pat] of Object.entries(CHORD_DICT)){ const reduced=[...new Set(pat.map(x=>mod(x,OCTAVE)))].sort((a,b)=>a-b); const score=intersection(trans,reduced).length; const exact=eqArr(trans,reduced); if(!best || exact || score>best.score){ best={score,name: pcName(root)+" "+qual, root, inv: invOf(midiNotes, root), exact}; if(exact) return {...best, detail: best.inv?`(${best.inv})`:""}; } } } return best? {...best, detail: (best.inv?`(${best.inv}) `:"")+"~approx"} : {name:"?", detail:""}; }

// ========================= AUDIO (Tone.js) =========================
let _synth=null; let _started=false; const ENV={
  Piano:{a:.002,d:.3,s:.3,r:1.2,osc:'triangle'},
  Guitar:{a:.002,d:.25,s:0,r:1.5,osc:'sawtooth'},
  Bass:{a:.005,d:.25,s:.4,r:.8,osc:'square'},
  Violin:{a:.01,d:.12,s:.7,r:.6,osc:'sawtooth'},
  Flute:{a:.04,d:.12,s:.8,r:.5,osc:'sine'},
  Recorder:{a:.03,d:.15,s:.7,r:.4,osc:'sine'},
  Trumpet:{a:.01,d:.2,s:.6,r:.5,osc:'sawtooth'},
  Saxophone:{a:.02,d:.2,s:.6,r:.3,osc:'sawtooth'},
  Koto:{a:.002,d:.3,s:0,r:1.6,osc:'triangle'},
  Oud:{a:.002,d:.35,s:0,r:1.8,osc:'triangle'},
  Ney:{a:.08,d:.12,s:.7,r:.5,osc:'sine'},
  'Hammond Organ':{a:.03,d:.2,s:.8,r:.7,osc:'square'}
};
async function ensureTone(instr){ if(!_started){ try{ await Tone.start(); }catch{} _started=true; } if(!_synth){ _synth = new Tone.PolySynth(Tone.Synth).toDestination(); } const p=ENV[instr]||ENV.Piano; _synth.set({ envelope:{attack:p.a, decay:p.d, sustain:p.s, release:p.r}, oscillator:{type:p.osc} }); }
function midiName(m){ const pc=mod(m,OCTAVE), oct=Math.floor(m/OCTAVE)-1; return pcName(pc)+oct; }
// Convert (possibly fractional) MIDI note numbers to Hz
function midiToFreq(m){ return 440 * Math.pow(2, (m - 69) / 12); }
// Plays MIDI notes using the synth. Notes are sequenced by default;
// use `asChord` to trigger them simultaneously or `strum` for a quick
// guitar-style roll.
async function playMidiNotes(list, {instrument='Piano', tempo=110, asChord=false, strum=false, noteDur}={}){
  await ensureTone(instrument);
  const beat=60/tempo;
  const now=Tone.now();
  if(asChord){
    _synth.triggerAttackRelease(list.map(midiToFreq), beat*2, now);
    return;
  }
  if(strum){
    list.forEach((m,i)=>{
      const t=now + i*(beat/6);
      _synth.triggerAttackRelease(midiToFreq(m), beat*1.2, t);
    });
    return;
  }
  if(noteDur!==undefined && list.length===1){
    _synth.triggerAttackRelease(midiToFreq(list[0]), noteDur, now);
    return;
  }
  const seq=list;
  seq.forEach((m,i)=>{
    const t=now + i*(beat*0.6);
    _synth.triggerAttackRelease(midiToFreq(m), beat*0.9, t);
  });
}
// Limitation: only oscillator-based synth; sample instruments would require per-voice pitch bend.

// ========================= MIDI (SMF Type 0) =========================
function encVarLen(v){ let buffer=v & 0x7F; const out=[]; while((v >>= 7)){ buffer <<= 8; buffer |= ((v & 0x7F) | 0x80); } while(true){ out.push(buffer & 0xFF); if(buffer & 0x80) buffer >>= 8; else break; } return new Uint8Array(out); }
const u32=n=>new Uint8Array([(n>>>24)&255,(n>>>16)&255,(n>>>8)&255,n&255]); const u16=n=>new Uint8Array([(n>>>8)&255,n&255]); const strBytes=s=> new TextEncoder().encode(s);
function buildMidi(noteEvents, ppq=96, bpm=130){ const hd=new Uint8Array([...strBytes('MThd'),...u32(6),...u16(0),...u16(1),...u16(ppq)]); const uspq=Math.round(60000000/bpm); const tempo=new Uint8Array([0x00,0xFF,0x51,0x03,(uspq>>>16)&255,(uspq>>>8)&255,uspq&255]); noteEvents.sort((a,b)=>a.start-b.start); let t=0; const ev=[]; for(const e of noteEvents){ const onTicks=Math.round(e.start*ppq)-t; t+=onTicks; ev.push(...encVarLen(onTicks), 0x90, e.midi&127, (e.vel??100)&127); const offTicks=Math.round(e.dur*ppq); ev.push(...encVarLen(offTicks), 0x80, e.midi&127, 0); } ev.push(0x00,0xFF,0x2F,0x00); const trkData=new Uint8Array([...tempo, ...ev]); const trk=new Uint8Array([...strBytes('MTrk'), ...u32(trkData.length), ...trkData]); return new Uint8Array([...hd, ...trk]); }
async function copyBytesToClipboard(bytes){ const status=document.getElementById('copyStatus'); if(window.ClipboardItem){ try{ const item=new ClipboardItem({'audio/midi': new Blob([bytes],{type:'audio/midi'})}); await navigator.clipboard.write([item]); status.textContent='✅ Copied MIDI bytes. In FL: Piano roll → Edit → Paste from clipboard (Score).'; return true; }catch(e){ status.textContent='⚠️ Browser blocked binary clipboard. Use Download .MID instead.'; return false; } } else { status.textContent='⚠️ ClipboardItem not available. Use Download .MID.'; return false; } }

// ========================= UI STATE =========================
const $ = (sel)=>document.querySelector(sel);
const pianoHost = $('#pianoHost'); const guitarHost = $('#guitarHost'); const bassHost = $('#bassHost'); const violinHost = $('#violinHost'); const fluteHost = $('#fluteHost'); const recorderHost = $('#recorderHost'); const trumpetHost = $('#trumpetHost'); const saxophoneHost = $('#saxophoneHost'); const kotoHost = $('#kotoHost'); const neyHost = $('#neyHost');
const selKey = $('#selKey'); const selQuality = $('#selQuality'); const selMode = $('#selMode'); const selInstr = $('#selInstr'); const selSystem = $('#selSystem');
const badgeRoot = $('#badgeRoot'); const badgeChordNotes = $('#badgeChordNotes'); const badgeScaleNotes = $('#badgeScaleNotes');
const badgeId = $('#badgeId'); const badgeSelNotes = $('#badgeSelNotes');
const btnModeChord = $('#btnModeChord'); const btnModeScale = $('#btnModeScale');
const wrapChord = $('#wrapChord'); const wrapScale = $('#wrapScale');
const listenChord = $('#listenChord'); const listenScale = $('#listenScale'); const btnPlayStrum = $('#btnPlayStrum');
const btnPlaySelChord = $('#btnPlaySelChord'); const btnPlaySelArp = $('#btnPlaySelArp');
const heldSustainSnap = $('#heldSustainSnap');
const tempoInput = $('#tempo');

let mode = 'Chord';
let instrument = 'Piano';
let keyRoot = 'C';
let chordQuality = 'Maj';
let scaleMode = 'Ionian';
let system = 'Western';
let tempo = 110;
let fluteLeftToRight = true;
let recorderLeftToRight = true;
let neyLeftToRight = true;
let fluteOrientation = 'horizontal';
let recorderOrientation = 'horizontal';
let neyOrientation = 'horizontal';
let trumpetLeftToRight = true;
let trumpetOrientation = 'horizontal';
let saxophoneLeftToRight = true;
let saxophoneOrientation = 'horizontal';

// Selection for chord identification
const selection = new Set(); // midi numbers

function updateSelButtons(){
  const empty = selection.size === 0;
  btnPlaySelChord.disabled = empty;
  btnPlaySelArp.disabled = empty;
}

// Build selects
function fillSelect(el, arr){ el.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join(''); }
fillSelect(selKey, KEYS); selKey.value = keyRoot; fillSelect(selInstr, INSTRUMENTS); selInstr.value=instrument;
fillSelect(selQuality, Object.keys(CHORD_QUALITIES)); selQuality.value=chordQuality;
fillSelect(selSystem, Object.keys(MODE_SYSTEMS)); selSystem.value = system;
function populateModeOptions(){
  fillSelect(selMode, MODE_SYSTEMS[system]);
  if(!MODE_SYSTEMS[system].includes(scaleMode)) scaleMode = MODE_SYSTEMS[system][0];
  selMode.value = scaleMode;
}
populateModeOptions();

function updateBadges(){
  badgeRoot.textContent = 'Root: '+toSharpName(keyRoot);
  const selected = computeSelected();
  if(mode==='Chord'){ badgeChordNotes.textContent = 'Notes: '+selected.notes.join('-'); }
  else { badgeScaleNotes.textContent = 'Scale: '+selected.notes.join('-'); }
  const arr=[...selection].sort((a,b)=>a-b);
  const id=chordNameFromNotes(arr);
  badgeId.textContent = 'Selection: '+id.name+(id.detail?(' '+id.detail):'');
  badgeSelNotes.textContent = 'Notes: ' + (arr.length? arr.map(m=> pcName(mod(m,OCTAVE))+(Math.floor(m/OCTAVE)-1)).join(' '): '—');
  updateSelButtons();
}

function computeSelected(){ if(mode==='Chord'){ const notes=buildChord(keyRoot, chordQuality); return {type:'chord', notes, pcset:makePcSet(notes), rootPc: pcIndex(keyRoot)}; } else { const notes=buildScale(keyRoot, scaleMode); return {type:'scale', notes, pcset:makePcSet(notes), rootPc: pcIndex(keyRoot)}; } }

// ========================= PIANO =========================
function buildPiano(){ pianoHost.innerHTML=''; const container=document.createElement('div'); container.className='relative mx-auto select-none'; const shell=document.createElement('div'); shell.className='relative h-48 bg-slate-900 border border-slate-700 rounded-xl p-2'; container.appendChild(shell);
  // White keys row
  const startMidi=midiFrom('C',3); const endMidi=midiFrom('F',5); const keys=[]; for(let m=startMidi;m<=endMidi;m++) keys.push(m); const whites=keys.filter(m=>![1,3,6,8,10].includes(mod(m,OCTAVE)));
  const whiteRow=document.createElement('div'); whiteRow.className='flex h-full'; shell.appendChild(whiteRow);
  whites.forEach(m=>{ const pc=mod(m,OCTAVE); const k=document.createElement('div'); k.dataset.midi=String(m); k.dataset.pc=String(pc); k.className='white-key relative flex-1 mx-0.5 rounded-b-xl border bg-white border-slate-400'; const lbl=document.createElement('div'); lbl.className='absolute inset-x-0 bottom-1 text-center text-[10px] text-slate-700 select-none'; lbl.textContent = pcName(pc)+(Math.floor(m/OCTAVE)-1); k.appendChild(lbl);
    k.addEventListener('pointerdown', (ev)=>{ if(ev.shiftKey){ toggleSelect(m); updateBadges(); renderHighlights(); } else { k.setPointerCapture(ev.pointerId); k.dataset.start=String(performance.now()); } });
    const end=(ev)=>{ const s=k.dataset.start; if(!s) return; let dur=(performance.now()-Number(s))/1000; dur=Math.min(6, Math.max(0.05, dur)); if(heldSustainSnap.checked){ const beat=60/tempo; const sixteenth=beat/4; dur=Math.round(dur/sixteenth)*sixteenth; } playMidiNotes([m],{instrument, tempo, noteDur:dur}); delete k.dataset.start; updateBadges(); renderHighlights(); };
    k.addEventListener('pointerup', end); k.addEventListener('pointercancel', end);
    whiteRow.appendChild(k); });
  // Black overlay (pointer-enabled only on keys)
  const overlay=document.createElement('div'); overlay.className='pointer-events-none absolute left-2 right-2 top-2 bottom-2 flex'; shell.appendChild(overlay);
  keys.filter(m=>[1,3,6,8,10].includes(mod(m,OCTAVE))).forEach(m=>{ const pc=mod(m,OCTAVE); const wrap=document.createElement('div'); wrap.className='relative w-[6.66%] mx-[1.67%]'; wrap.style.visibility = [1,3,6,8,10].includes(pc)?'visible':'hidden'; const blk=document.createElement('div'); blk.dataset.midi=String(m); blk.dataset.pc=String(pc); blk.className='black-key absolute left-1/2 -translate-x-1/2 w-3/5 h-2/3 rounded-b-lg border bg-black border-black pointer-events-auto'; blk.title = pcName(pc)+(Math.floor(m/OCTAVE)-1); const lbl=document.createElement('div'); lbl.className='absolute inset-x-0 bottom-1 text-center text-[9px] text-rose-200 font-bold select-none'; lbl.textContent=''; blk.appendChild(lbl);
    blk.addEventListener('pointerdown', (ev)=>{ if(ev.shiftKey){ toggleSelect(m); updateBadges(); renderHighlights(); } else { blk.setPointerCapture(ev.pointerId); blk.dataset.start=String(performance.now()); } });
    const end=(ev)=>{ const s=blk.dataset.start; if(!s) return; let dur=(performance.now()-Number(s))/1000; dur=Math.min(6, Math.max(0.05, dur)); if(heldSustainSnap.checked){ const beat=60/tempo; const sixteenth=beat/4; dur=Math.round(dur/sixteenth)*sixteenth; } playMidiNotes([m],{instrument, tempo, noteDur:dur}); delete blk.dataset.start; updateBadges(); renderHighlights(); };
    blk.addEventListener('pointerup', end); blk.addEventListener('pointercancel', end);
    wrap.appendChild(blk); overlay.appendChild(wrap); });
  pianoHost.appendChild(container);
}
function toggleSelect(m){ if(selection.has(m)) selection.delete(m); else selection.add(m); }
function clearSelection(){ selection.clear(); updateBadges(); renderHighlights(); }
function renderHighlights(){ const {pcset, rootPc} = computeSelected(); // visual highlight comes from chosen chord/scale
  // Whites (robust selector — no Tailwind arbitrary value in query)
  pianoHost.querySelectorAll('.white-key').forEach((el)=>{ const m=Number(el.dataset.midi); const pc=mod(m,OCTAVE); const active=pcset.has(pc); el.className = 'white-key relative flex-1 mx-0.5 rounded-b-xl border '+(active? 'bg-amber-200 border-amber-500':'bg-white border-slate-400');
    const rootBadge = el.querySelector('.rootbadge'); if(rootBadge) rootBadge.remove(); if(rootPc===pc){ const b=document.createElement('div'); b.className='rootbadge absolute inset-x-0 bottom-1 text-center text-[10px] text-rose-600 font-bold'; b.textContent='ROOT'; el.appendChild(b); } });
  // Blacks (robust selector)
  pianoHost.querySelectorAll('.black-key').forEach((el)=>{ const m=Number(el.dataset.midi); const pc=mod(m,OCTAVE); const active=pcset.has(pc); el.className = 'black-key absolute left-1/2 -translate-x-1/2 w-3/5 h-2/3 rounded-b-lg border '+(active? 'bg-indigo-400 border-indigo-600':'bg-black border-black')+' pointer-events-auto'; const r=el.querySelector('.rootchar'); if(r) r.remove(); if(rootPc===pc){ const rr=document.createElement('div'); rr.className='rootchar absolute inset-x-0 bottom-1 text-center text-[9px] text-rose-200 font-bold'; rr.textContent='R'; el.appendChild(rr); } });
}

// ========================= FRETBOARDS =========================
const GUITAR_STD=[40,45,50,55,59,64]; const BASS_STD=[28,33,38,43]; const VIOLIN_TUNING=[55,62,69,76]; const KOTO_TUNING=[60,62,64,67,69,72,74,76,79,81,84,86,88];
function buildFretboard(host, tuning, title){ host.innerHTML=''; const outer=document.createElement('div'); outer.className='w-full'; const titleEl=document.createElement('div'); titleEl.className='text-sm text-slate-300 mb-2'; titleEl.textContent = `${title} • Tuning: ` + tuning.map(m=> pcName(mod(m,OCTAVE))+(Math.floor(m/OCTAVE)-1)).join(' '); outer.appendChild(titleEl); const box=document.createElement('div'); box.className='bg-slate-900 rounded-xl border border-slate-700 p-3'; const grid=document.createElement('div'); grid.className='grid'; const frets=13; grid.style.gridTemplateColumns = `repeat(${frets+1}, minmax(0,1fr))`; box.appendChild(grid); // header row
  grid.appendChild(document.createElement('div')); for(let f=0; f<frets; f++){ const d=document.createElement('div'); d.className='text-center text-[10px] text-slate-400'; d.textContent=String(f); grid.appendChild(d); }
  const {pcset, rootPc} = computeSelected(); const strings=tuning.length; for(let s=0; s<strings; s++){ const stringIndex=strings-1-s; const openMidi=tuning[stringIndex]; const lab=document.createElement('div'); lab.className='text-right pr-2 text-[11px] text-slate-400'; lab.textContent=pcName(mod(openMidi,OCTAVE)); grid.appendChild(lab); for(let f=0; f<frets; f++){ const midi=openMidi+f; const pc=mod(midi,OCTAVE); const cell=document.createElement('div'); cell.className='relative h-10 border border-slate-700/70'; if(pcset.has(pc)){ const dot=document.createElement('div'); dot.className = 'absolute inset-1 rounded-full flex items-center justify-center text-[10px] font-semibold '+ (rootPc===pc? 'bg-rose-500/80 text-white':'bg-emerald-400/80 text-black'); dot.title = `${pcName(pc)} @ string ${stringIndex+1}, fret ${f}`; dot.textContent = (rootPc===pc? 'R': pcName(pc)); cell.appendChild(dot); } grid.appendChild(cell); } }
  outer.appendChild(box); const note=document.createElement('div'); note.className='mt-2 text-center text-xs text-slate-400'; note.textContent='Colored dots = playable notes on that string/fret. Red = root.'; outer.appendChild(note); host.appendChild(outer); }

function buildKotoBoard(){ kotoHost.innerHTML=''; const outer=document.createElement('div'); outer.className='w-full'; const titleEl=document.createElement('div'); titleEl.className='text-sm text-slate-300 mb-2'; titleEl.textContent='Koto • Tuning: '+KOTO_TUNING.map(m=> pcName(mod(m,OCTAVE))+(Math.floor(m/OCTAVE)-1)).join(' '); outer.appendChild(titleEl); const board=document.createElement('div'); board.className='bg-slate-900 rounded-xl border border-slate-700 p-3'; const {pcset, rootPc} = computeSelected(); KOTO_TUNING.forEach((m)=>{ const pc=mod(m,OCTAVE); const row=document.createElement('div'); row.className='relative h-5 my-1 flex items-center'; const line=document.createElement('div'); line.className='w-full h-0.5'; line.style.backgroundColor = pcset.has(pc)? (rootPc===pc? '#f43f5e':'#4ade80') : '#cbd5e1'; row.appendChild(line); const lab=document.createElement('div'); lab.className='absolute -left-2 -translate-x-full text-xs text-slate-400'; lab.textContent=pcName(pc)+(Math.floor(m/OCTAVE)-1); row.appendChild(lab); if(pcset.has(pc)){ const dot=document.createElement('div'); dot.className='absolute right-0 top-1/2 -translate-y-1/2 px-1 text-[10px] font-semibold rounded '+(rootPc===pc? 'bg-rose-500/80 text-white':'bg-emerald-400/80 text-black'); dot.textContent = rootPc===pc? 'R': pcName(pc); row.appendChild(dot); } board.appendChild(row); }); outer.appendChild(board); kotoHost.appendChild(outer); }

// ========================= FLUTE CHART =========================
const FLUTE_FINGERINGS = {
  C:[1,1,1,1,1,1],
  'C#':[0,1,1,1,1,1],
  D:[0,1,1,1,1,1],
  'D#':[0,0,1,1,1,1],
  E:[0,0,1,1,1,1],
  F:[0,0,0,1,1,1],
  'F#':[0,0,0,0,1,1],
  G:[0,0,0,0,1,1],
  'G#':[0,0,0,0,0,1],
  A:[0,0,0,0,0,1],
  'A#':[0,0,0,0,0,0],
  B:[0,0,0,0,0,0]
};
/*
  Flute chart layout
  - ViewBox: 0 0 160 60 (overall diagram size)
  - Hole spacing: i*22 (horizontal positioning)
  - Hole radius: r=10
  Change these numbers to resize the chart or adjust hole placement for custom layouts.
*/
function buildFluteChart(){
  const {rootPc} = computeSelected();
  const note = pcName(rootPc);
  const sharp = ENHARMONIC_MAP[note] || note;
  const fing = FLUTE_FINGERINGS[sharp] || [0,0,0,0,0,0];
  fluteHost.innerHTML='';
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg');
  const isHoriz = fluteOrientation === 'horizontal';
  svg.setAttribute('viewBox', isHoriz ? '0 0 160 60' : '0 0 60 160');
  svg.setAttribute('class','mx-auto');
  fing.forEach((closed,i)=>{
    const c=document.createElementNS(svgNS,'circle');
    let x,y;
    if(isHoriz){
      x = fluteLeftToRight ? 20 + i*22 : 140 - i*22;
      y = 30;
    } else {
      y = fluteLeftToRight ? 20 + i*22 : 140 - i*22;
      x = 30;
    }
    c.setAttribute('cx', String(x));
    c.setAttribute('cy', String(y));
    c.setAttribute('r','10');
    c.setAttribute('stroke','#fbbf24');
    c.setAttribute('stroke-width','2');
    c.setAttribute('fill', closed ? '#fbbf24' : 'transparent');
    svg.appendChild(c);
  });
  fluteHost.appendChild(svg);
  const flip=document.createElement('button');
  flip.id='fluteFlip';
  flip.textContent = isHoriz ? 'Flip ↔' : 'Flip ↕';
  flip.className='mt-2 text-xs px-2 py-1 border border-slate-700 rounded';
  fluteHost.appendChild(flip);
  const orient=document.createElement('button');
  orient.id='fluteOrient';
  orient.textContent = fluteOrientation === 'horizontal' ? 'Vertical' : 'Horizontal';
  orient.className='mt-2 ml-2 text-xs px-2 py-1 border border-slate-700 rounded';
  fluteHost.appendChild(orient);
  const lbl=document.createElement('div');
  lbl.className='mt-2 text-center text-xs text-slate-400';
  lbl.textContent=`Fingering for ${sharp}`;
  fluteHost.appendChild(lbl);
  document.getElementById('fluteFlip').onclick = () => {
    fluteLeftToRight = !fluteLeftToRight;
    buildFluteChart();
  };
  document.getElementById('fluteOrient').onclick = () => {
    fluteOrientation = fluteOrientation === 'horizontal' ? 'vertical' : 'horizontal';
    buildFluteChart();
  };
}

// ========================= RECORDER CHART =========================
const RECORDER_FINGERINGS = {
  C:[1,1,1,1,1,1,1,1],
  'C#':[0,1,1,1,1,1,1,1],
  D:[0,1,1,1,1,1,1,1],
  'D#':[0,0,1,1,1,1,1,1],
  E:[0,0,1,1,1,1,1,1],
  F:[0,0,0,1,1,1,1,1],
  'F#':[0,0,0,0,1,1,1,1],
  G:[0,0,0,0,1,1,1,1],
  'G#':[0,0,0,0,0,1,1,1],
  A:[0,0,0,0,0,1,1,1],
  'A#':[0,0,0,0,0,0,1,1],
  B:[0,0,0,0,0,0,1,1]
};
/*
  Recorder chart layout
  - ViewBox: 0 0 180 60 (overall diagram size)
  - Hole spacing: i*20 (horizontal positioning)
  - Hole radius: r=8
  Adjust these values to change chart size, spacing, or hole size for custom recorders.
*/
function buildRecorderChart(){
  const {rootPc} = computeSelected();
  const note = pcName(rootPc);
  const sharp = ENHARMONIC_MAP[note] || note;
  const fing = RECORDER_FINGERINGS[sharp] || [0,0,0,0,0,0,0,0];
  recorderHost.innerHTML='';
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg');
  const isHoriz = recorderOrientation === 'horizontal';
  svg.setAttribute('viewBox', isHoriz ? '0 0 180 60' : '0 0 60 180');
  svg.setAttribute('class','mx-auto');
  fing.forEach((closed,i)=>{
    const c=document.createElementNS(svgNS,'circle');
    let x,y;
    if(isHoriz){
      x = recorderLeftToRight ? 20 + i*20 : 160 - i*20;
      y = 30;
    } else {
      y = recorderLeftToRight ? 20 + i*20 : 160 - i*20;
      x = 30;
    }
    c.setAttribute('cx', String(x));
    c.setAttribute('cy', String(y));
    c.setAttribute('r','8');
    c.setAttribute('stroke','#fbbf24');
    c.setAttribute('stroke-width','2');
    c.setAttribute('fill', closed ? '#fbbf24' : 'transparent');
    svg.appendChild(c);
  });
  recorderHost.appendChild(svg);
  const flip=document.createElement('button');
  flip.id='recorderFlip';
  flip.textContent = isHoriz ? 'Flip ↔' : 'Flip ↕';
  flip.className='mt-2 text-xs px-2 py-1 border border-slate-700 rounded';
  recorderHost.appendChild(flip);
  const orient=document.createElement('button');
  orient.id='recorderOrient';
  orient.textContent = recorderOrientation === 'horizontal' ? 'Vertical' : 'Horizontal';
  orient.className='mt-2 ml-2 text-xs px-2 py-1 border border-slate-700 rounded';
  recorderHost.appendChild(orient);
  const lbl=document.createElement('div');
  lbl.className='mt-2 text-center text-xs text-slate-400';
  lbl.textContent=`Fingering for ${sharp}`;
  recorderHost.appendChild(lbl);
  document.getElementById('recorderFlip').onclick = () => {
    recorderLeftToRight = !recorderLeftToRight;
    buildRecorderChart();
  };
  document.getElementById('recorderOrient').onclick = () => {
    recorderOrientation = recorderOrientation === 'horizontal' ? 'vertical' : 'horizontal';
    buildRecorderChart();
  };
}

// ========================= TRUMPET CHART =========================
const TRUMPET_FINGERINGS = {
  C:[0,0,0],
  'C#':[1,1,1],
  D:[1,0,1],
  'D#':[0,1,1],
  E:[1,1,0],
  F:[1,0,0],
  'F#':[0,1,0],
  G:[0,0,0],
  'G#':[0,1,1],
  A:[1,1,0],
  'A#':[1,0,0],
  B:[0,1,0]
};
/*
  Trumpet chart layout
  - ViewBox: 0 0 120 60 (overall diagram size)
  - Valve spacing: i*40 (positioning)
  - Valve radius: r=12
  Adjust these numbers to resize the chart or reposition valves.
*/
function buildTrumpetChart(){
  const {rootPc} = computeSelected();
  const note = pcName(rootPc);
  const sharp = ENHARMONIC_MAP[note] || note;
  const fing = TRUMPET_FINGERINGS[sharp] || [0,0,0];
  trumpetHost.innerHTML='';
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg');
  const isHoriz = trumpetOrientation === 'horizontal';
  svg.setAttribute('viewBox', isHoriz ? '0 0 120 60' : '0 0 60 120');
  svg.setAttribute('class','mx-auto');
  fing.forEach((down,i)=>{
    const c=document.createElementNS(svgNS,'circle');
    let x,y;
    if(isHoriz){
      x = trumpetLeftToRight ? 20 + i*40 : 100 - i*40;
      y = 30;
    } else {
      y = trumpetLeftToRight ? 20 + i*40 : 100 - i*40;
      x = 30;
    }
    c.setAttribute('cx',String(x));
    c.setAttribute('cy',String(y));
    c.setAttribute('r','12');
    c.setAttribute('stroke','#fbbf24');
    c.setAttribute('stroke-width','2');
    c.setAttribute('fill', down ? '#fbbf24' : 'transparent');
    svg.appendChild(c);
  });
  trumpetHost.appendChild(svg);
  const flip=document.createElement('button');
  flip.id='trumpetFlip';
  flip.textContent = isHoriz ? 'Flip ↔' : 'Flip ↕';
  flip.className='mt-2 text-xs px-2 py-1 border border-slate-700 rounded';
  trumpetHost.appendChild(flip);
  const orient=document.createElement('button');
  orient.id='trumpetOrient';
  orient.textContent = trumpetOrientation === 'horizontal' ? 'Vertical' : 'Horizontal';
  orient.className='mt-2 ml-2 text-xs px-2 py-1 border border-slate-700 rounded';
  trumpetHost.appendChild(orient);
  const lbl=document.createElement('div');
  lbl.className='mt-2 text-center text-xs text-slate-400';
  lbl.textContent=`Valve combo for ${sharp}`;
  trumpetHost.appendChild(lbl);
  document.getElementById('trumpetFlip').onclick = () => {
    trumpetLeftToRight = !trumpetLeftToRight;
    buildTrumpetChart();
  };
  document.getElementById('trumpetOrient').onclick = () => {
    trumpetOrientation = trumpetOrientation === 'horizontal' ? 'vertical' : 'horizontal';
    buildTrumpetChart();
  };
}

// ========================= SAXOPHONE CHART =========================
const SAX_FINGERINGS = {
  C:[1,1,1,1,1,1],
  'C#':[0,1,1,1,1,1],
  D:[0,1,1,1,1,1],
  'D#':[0,0,1,1,1,1],
  E:[0,0,1,1,1,1],
  F:[0,0,0,1,1,1],
  'F#':[0,0,0,0,1,1],
  G:[0,0,0,0,1,1],
  'G#':[0,0,0,0,0,1],
  A:[0,0,0,0,0,1],
  'A#':[0,0,0,0,0,0],
  B:[0,0,0,0,0,0]
};
/*
  Saxophone chart layout
  - ViewBox: 0 0 160 60 (overall diagram size)
  - Key spacing: i*22 (positioning)
  - Key radius: r=10
  Adjust these values to resize the chart or reposition keys.
*/
function buildSaxophoneChart(){
  const {rootPc} = computeSelected();
  const note = pcName(rootPc);
  const sharp = ENHARMONIC_MAP[note] || note;
  const fing = SAX_FINGERINGS[sharp] || [0,0,0,0,0,0];
  saxophoneHost.innerHTML='';
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg');
  const isHoriz = saxophoneOrientation === 'horizontal';
  svg.setAttribute('viewBox', isHoriz ? '0 0 160 60' : '0 0 60 160');
  svg.setAttribute('class','mx-auto');
  fing.forEach((closed,i)=>{
    const c=document.createElementNS(svgNS,'circle');
    let x,y;
    if(isHoriz){
      x = saxophoneLeftToRight ? 20 + i*22 : 140 - i*22;
      y = 30;
    } else {
      y = saxophoneLeftToRight ? 20 + i*22 : 140 - i*22;
      x = 30;
    }
    c.setAttribute('cx', String(x));
    c.setAttribute('cy', String(y));
    c.setAttribute('r','10');
    c.setAttribute('stroke','#fbbf24');
    c.setAttribute('stroke-width','2');
    c.setAttribute('fill', closed ? '#fbbf24' : 'transparent');
    svg.appendChild(c);
  });
  saxophoneHost.appendChild(svg);
  const flip=document.createElement('button');
  flip.id='saxophoneFlip';
  flip.textContent = isHoriz ? 'Flip ↔' : 'Flip ↕';
  flip.className='mt-2 text-xs px-2 py-1 border border-slate-700 rounded';
  saxophoneHost.appendChild(flip);
  const orient=document.createElement('button');
  orient.id='saxophoneOrient';
  orient.textContent = saxophoneOrientation === 'horizontal' ? 'Vertical' : 'Horizontal';
  orient.className='mt-2 ml-2 text-xs px-2 py-1 border border-slate-700 rounded';
  saxophoneHost.appendChild(orient);
  const lbl=document.createElement('div');
  lbl.className='mt-2 text-center text-xs text-slate-400';
  lbl.textContent=`Fingering for ${sharp}`;
  saxophoneHost.appendChild(lbl);
  document.getElementById('saxophoneFlip').onclick = () => {
    saxophoneLeftToRight = !saxophoneLeftToRight;
    buildSaxophoneChart();
  };
  document.getElementById('saxophoneOrient').onclick = () => {
    saxophoneOrientation = saxophoneOrientation === 'horizontal' ? 'vertical' : 'horizontal';
    buildSaxophoneChart();
  };
}

// ========================= NEY CHART =========================
const NEY_FINGERINGS = {
  C:[1,1,1,1,1,1,1],
  'C#':[0,1,1,1,1,1,1],
  D:[0,1,1,1,1,1,1],
  'D#':[0,0,1,1,1,1,1],
  E:[0,0,1,1,1,1,1],
  F:[0,0,0,1,1,1,1],
  'F#':[0,0,0,0,1,1,1],
  G:[0,0,0,0,1,1,1],
  'G#':[0,0,0,0,0,1,1],
  A:[0,0,0,0,0,1,1],
  'A#':[0,0,0,0,0,0,1],
  B:[0,0,0,0,0,0,0]
};
/*
  Ney chart layout
  - ViewBox: 0 0 60 160 (overall diagram size)
  - Hole spacing: 20 + i*22 (vertical positioning; first hole x=20, others x=30)
  - Hole radius: r=8
  Tweak these parameters to alter chart size, hole spacing, or radius for custom ney designs.
*/
function buildNeyChart(){
  const {rootPc} = computeSelected();
  const note = pcName(rootPc);
  const sharp = ENHARMONIC_MAP[note] || note;
  const fing = NEY_FINGERINGS[sharp] || [0,0,0,0,0,0,0];
  neyHost.innerHTML='';
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg');
  const isHoriz = neyOrientation === 'horizontal';
  svg.setAttribute('viewBox', isHoriz ? '0 0 160 60' : '0 0 60 160');
  svg.setAttribute('class','mx-auto');
  fing.forEach((closed,i)=>{
    const c=document.createElementNS(svgNS,'circle');
    let x,y;
    if(isHoriz){
      x = neyLeftToRight ? 20 + i*22 : 140 - i*22;
      y = 30;
    } else {
      x = i===0 ? 20 : 30;
      y = neyLeftToRight ? 20 + i*22 : 140 - i*22;
    }
    c.setAttribute('cx', String(x));
    c.setAttribute('cy', String(y));
    c.setAttribute('r','8');
    c.setAttribute('stroke','#fbbf24');
    c.setAttribute('stroke-width','2');
    c.setAttribute('fill', closed ? '#fbbf24' : 'transparent');
    svg.appendChild(c);
  });
  neyHost.appendChild(svg);
  const flip=document.createElement('button');
  flip.id='neyFlip';
  flip.textContent = isHoriz ? 'Flip ↔' : 'Flip ↕';
  flip.className='mt-2 text-xs px-2 py-1 border border-slate-700 rounded';
  neyHost.appendChild(flip);
  const orient=document.createElement('button');
  orient.id='neyOrient';
  orient.textContent = neyOrientation === 'horizontal' ? 'Vertical' : 'Horizontal';
  orient.className='mt-2 ml-2 text-xs px-2 py-1 border border-slate-700 rounded';
  neyHost.appendChild(orient);
  const lbl=document.createElement('div');
  lbl.className='mt-2 text-center text-xs text-slate-400';
  lbl.textContent=`Fingering for ${sharp}`;
  neyHost.appendChild(lbl);
  document.getElementById('neyFlip').onclick = () => {
    neyLeftToRight = !neyLeftToRight;
    buildNeyChart();
  };
  document.getElementById('neyOrient').onclick = () => {
    neyOrientation = neyOrientation === 'horizontal' ? 'vertical' : 'horizontal';
    buildNeyChart();
  };
}

// ========================= EXPORT HELPERS =========================
function buildNoteEvents(){ const cur=computeSelected(); if(cur.type==='chord'){ const list=chordToMidi(cur.notes, keyRoot, instrument.startsWith('Bass')?2:4); const start=0,dur=1; return list.map(m=>({start,dur,midi:m,vel:100})); } const seq=scaleToMidi(cur.notes, keyRoot, instrument.startsWith('Bass')?2:4); return seq.map((m,i)=>({start:i*0.5, dur:0.45, midi:m, vel:100})); }
function copyCSV(){ const ev=buildNoteEvents(); const toName=m=> pcName(mod(m,OCTAVE))+(Math.floor(m/OCTAVE)-1); const lines=['note,start(dur beats),dur,vel', ...ev.map(e=> `${toName(e.midi)},${e.start.toFixed(3)},${e.dur.toFixed(3)},${e.vel}`)]; return navigator.clipboard.writeText(lines.join('\n')); }
function downloadMID(){ const bytes=buildMidi(buildNoteEvents(),96,130); const blob=new Blob([bytes],{type:'audio/midi'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${keyRoot}-${mode==='chord'?chordQuality:scaleMode}.mid`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1500); }

// ========================= TESTS =========================
function addTest(list, name, pass, details){ list.push({name,pass,details}); }
function runTests(){
  const t=[];
  addTest(t,'pcIndex C = 0', pcIndex('C')===0);
  addTest(t,'pcIndex C# = 1', pcIndex('C#')===1);
  addTest(t,'pcIndex C+ = 0.5', pcIndex('C+')===0.5);
  addTest(t,'pcName 0.5 = C+', pcName(0.5)==='C+');
  addTest(t,'toSharp(Db)=C#', toSharpName('Db')==='C#');
  addTest(t,'toSharp(E#)=F', toSharpName('E#')==='F');
  addTest(t,'toSharp(B#)=C', toSharpName('B#')==='C');
  addTest(t,'toSharp(Cb)=B', toSharpName('Cb')==='B');
  addTest(t,'C Ionian ok', JSON.stringify(buildScale('C','Ionian'))===JSON.stringify(['C','D','E','F','G','A','B']));
  addTest(t,'A Dorian ok', JSON.stringify(buildScale('A','Dorian'))===JSON.stringify(['A','B','C','D','E','F#','G']));
  addTest(t,'E Blues has A#', buildScale('E','Blues').includes('A#'));
  addTest(t,'G Mixolydian len=7', buildScale('G','Mixolydian').length===7);
  addTest(t,'A Major Pentatonic len=5', buildScale('A','Major Pentatonic').length===5);
  addTest(t,'C Maqam Rast has D#+', buildScale('C','Maqam Rast').includes('D#+'));
  addTest(t,'D Maqam Bayati has D#+', buildScale('D','Maqam Bayati')[1]==='D#+');
  addTest(t,'C Maj chord', JSON.stringify(buildChord('C','Maj'))===JSON.stringify(['C','E','G']));
  addTest(t,'G7 chord', JSON.stringify(buildChord('G','7'))===JSON.stringify(['G','B','D','F']));
  addTest(t,'Bm7b5 chord', JSON.stringify(buildChord('B','m7b5'))===JSON.stringify(['B','D','F','A']));
  addTest(t,'Dsus4 chord', JSON.stringify(buildChord('D','Sus4'))===JSON.stringify(['D','G','A']));
  const cm=chordToMidi(['C','E','G'],'C',4);
  addTest(t,'ChordToMidi >=3', cm.length>=3, cm.join(','));
  const sc=scaleToMidi(['C','D','E','F','G','A','B'],'C',4);
  addTest(t,'ScaleToMidi >=14', sc.length>=14, String(sc.length));
  const maq=scaleToMidi(buildScale('C','Maqam Rast'),'C',4);
  addTest(t,'ScaleToMidi quarter-tone', maq.includes(63.5));
  const fq=midiToFreq(60.5);
  addTest(t,'midiToFreq 60.5', Math.abs(fq - 440*Math.pow(2,(60.5-69)/12))<0.01, fq.toFixed(2));
  addTest(t,'MODE_SYSTEMS maqam', MODE_SYSTEMS.Maqam.includes('Maqam Rast'));
  const testsEl=document.getElementById('tests'); testsEl.innerHTML='';
  t.forEach((r)=>{ const li=document.createElement('div'); li.className='px-3 py-2 rounded-lg border '+ (r.pass?'border-emerald-700 bg-emerald-900/30 text-emerald-200':'border-rose-700 bg-rose-900/30 text-rose-200'); li.innerHTML = '<span class="font-semibold">'+(r.pass?'PASS':'FAIL')+'</span> — '+r.name + (r.details? ('<div class="text-xs opacity-75">'+r.details+'</div>'):''); testsEl.appendChild(li); });
}

// ========================= WIRING =========================
function refreshInstruments(){
  const isGuitar = selInstr.value.startsWith('Guitar') || selInstr.value.startsWith('Oud');
  const isBass = selInstr.value.startsWith('Bass');
  const isViolin = selInstr.value.startsWith('Violin');
  const isFlute = selInstr.value.startsWith('Flute');
  const isRecorder = selInstr.value.startsWith('Recorder');
  const isTrumpet = selInstr.value.startsWith('Trumpet');
  const isSaxophone = selInstr.value.startsWith('Saxophone');
  const isKoto = selInstr.value.startsWith('Koto');
  const isNey = selInstr.value.startsWith('Ney');
  guitarHost.classList.toggle('hidden', !isGuitar);
  bassHost.classList.toggle('hidden', !isBass);
  violinHost.classList.toggle('hidden', !isViolin);
  fluteHost.classList.toggle('hidden', !isFlute);
  recorderHost.classList.toggle('hidden', !isRecorder);
  trumpetHost.classList.toggle('hidden', !isTrumpet);
  saxophoneHost.classList.toggle('hidden', !isSaxophone);
  kotoHost.classList.toggle('hidden', !isKoto);
  neyHost.classList.toggle('hidden', !isNey);
  if(!violinHost.classList.contains('hidden')) buildFretboard(violinHost, VIOLIN_TUNING,'Violin (12 positions)');
  if(!fluteHost.classList.contains('hidden')) buildFluteChart();
  if(!recorderHost.classList.contains('hidden')) buildRecorderChart();
  if(!trumpetHost.classList.contains('hidden')) buildTrumpetChart();
  if(!saxophoneHost.classList.contains('hidden')) buildSaxophoneChart();
  if(!kotoHost.classList.contains('hidden')) buildKotoBoard();
  if(!neyHost.classList.contains('hidden')) buildNeyChart();
  btnPlayStrum.classList.toggle('hidden', !isGuitar);
}
function updateAll(){
  renderHighlights();
  updateBadges();
  if(!guitarHost.classList.contains('hidden'))
    buildFretboard(guitarHost, GUITAR_STD,'Guitar (12 frets)');
  if(!bassHost.classList.contains('hidden'))
    buildFretboard(bassHost, BASS_STD,'Bass (12 frets)');
  if(!violinHost.classList.contains('hidden'))
    buildFretboard(violinHost, VIOLIN_TUNING,'Violin (12 positions)');
  if(!fluteHost.classList.contains('hidden'))
    buildFluteChart();
  if(!recorderHost.classList.contains('hidden'))
    buildRecorderChart();
  if(!trumpetHost.classList.contains('hidden'))
    buildTrumpetChart();
  if(!saxophoneHost.classList.contains('hidden'))
    buildSaxophoneChart();
  if(!kotoHost.classList.contains('hidden'))
    buildKotoBoard();
  if(!neyHost.classList.contains('hidden'))
    buildNeyChart();
}

// Build UI
buildPiano(); refreshInstruments(); updateAll(); runTests();

btnModeChord.addEventListener('click', ()=>{ mode='Chord'; btnModeChord.className='px-3 py-2 text-sm bg-slate-700/70'; btnModeScale.className='px-3 py-2 text-sm bg-slate-800/60 hover:bg-slate-700/50'; wrapChord.classList.remove('hidden'); wrapScale.classList.add('hidden'); listenChord.classList.remove('hidden'); listenScale.classList.add('hidden'); updateAll(); });
btnModeScale.addEventListener('click', ()=>{ mode='Scale/Mode'; btnModeScale.className='px-3 py-2 text-sm bg-slate-700/70'; btnModeChord.className='px-3 py-2 text-sm bg-slate-800/60 hover:bg-slate-700/50'; wrapScale.classList.remove('hidden'); wrapChord.classList.add('hidden'); listenScale.classList.remove('hidden'); listenChord.classList.add('hidden'); updateAll(); });

selKey.addEventListener('change', (e)=>{ keyRoot = e.target.value; updateAll(); });
selQuality.addEventListener('change', (e)=>{ chordQuality = e.target.value; updateAll(); });
selMode.addEventListener('change', (e)=>{ scaleMode = e.target.value; updateAll(); });
selInstr.addEventListener('change', (e)=>{ instrument = e.target.value; refreshInstruments(); updateAll(); });
selSystem.addEventListener('change', (e)=>{ system = e.target.value; populateModeOptions(); updateAll(); });
tempoInput.addEventListener('change', (e)=>{ tempo = Number(e.target.value)||110; });
$('#btnClearSel').addEventListener('click', clearSelection);

// Listen buttons
$('#btnPlayBlock').addEventListener('click', ()=>{ const sel=computeSelected(); const midi=chordToMidi(sel.notes, keyRoot, instrument.startsWith('Bass')?2:4); playMidiNotes(midi,{instrument, tempo, asChord:true}); });
$('#btnPlayArp').addEventListener('click', ()=>{ const sel=computeSelected(); const midi=chordToMidi(sel.notes, keyRoot, instrument.startsWith('Bass')?2:4); playMidiNotes(midi,{instrument, tempo}); });
$('#btnPlayStrum').addEventListener('click', ()=>{ const sel=computeSelected(); const midi=chordToMidi(sel.notes, keyRoot, instrument.startsWith('Bass')?2:4); playMidiNotes(midi,{instrument, tempo, strum:true}); });
$('#btnPlayScale').addEventListener('click', ()=>{ const sel=computeSelected(); const midi=scaleToMidi(sel.notes, keyRoot, instrument.startsWith('Bass')?2:4); playMidiNotes(midi,{instrument, tempo}); });
$('#btnPlaySelChord').addEventListener('click', ()=>{ const midi=[...selection].sort((a,b)=>a-b); playMidiNotes(midi,{instrument, tempo, asChord:true}); });
$('#btnPlaySelArp').addEventListener('click', ()=>{ const midi=[...selection].sort((a,b)=>a-b); playMidiNotes(midi,{instrument, tempo}); });

// Export buttons
$('#btnCopyCSV').addEventListener('click', ()=>{ copyCSV().then(()=>{ $('#copyStatus').textContent='✅ Copied CSV'; }); });
$('#btnMid').addEventListener('click', downloadMID);
$('#btnCopyFL').addEventListener('click', ()=>{ const bytes=buildMidi(buildNoteEvents(),96,130); copyBytesToClipboard(bytes); });
</script>
</body>
</html>
