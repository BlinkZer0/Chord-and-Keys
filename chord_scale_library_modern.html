<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chord & Scale Library</title>
  
  <!-- External Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <script src="https://nbrosowsky.github.io/tonejs-instruments/Tonejs-Instruments.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  
  <style>
    /* Modern CSS Variables for theming */
    :root {
      --primary-bg: #0f172a;
      --secondary-bg: #1e293b;
      --accent-bg: #334155;
      --primary-text: #f8fafc;
      --secondary-text: #cbd5e1;
      --accent-color: #3b82f6;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --border-color: #475569;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    body {
      background: var(--primary-bg);
      color: var(--primary-text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.6;
    }

    .glass-card {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      border-radius: 12px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-color), #1d4ed8);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: var(--accent-bg);
      color: var(--primary-text);
      border: 1px solid var(--border-color);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .btn-secondary:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }

    .select-modern {
      background: var(--secondary-bg);
      color: var(--primary-text);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .select-modern:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--accent-bg);
      color: var(--secondary-text);
      border: 1px solid var(--border-color);
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .instrument-3d-container {
      width: 100%;
      height: 300px;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
    }

    .instrument-3d-canvas {
      width: 100%;
      height: 100%;
    }

    .fingering-indicator {
      position: absolute;
      width: 20px;
      height: 20px;
      background: rgba(34, 197, 94, 0.8);
      border: 2px solid #22c55e;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      transition: all 0.3s ease;
    }

    .fingering-indicator.root {
      background: rgba(239, 68, 68, 0.8);
      border-color: #ef4444;
    }

    .key-selected {
      box-shadow: 0 0 5px 2px rgba(34, 197, 94, 0.7);
    }

    .accordion-chevron {
      display: inline-block;
      transition: transform 0.2s ease;
      transform: rotate(-90deg);
    }

    .accordion[open] .accordion-chevron {
      transform: rotate(0deg);
    }

    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--accent-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .glass-card {
        margin: 0.5rem;
        padding: 1rem;
      }
      
      .btn-primary, .btn-secondary {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }
    }

    /* Debug styles */
    .debug-border {
      border: 2px solid red !important;
    }
    
    .debug-bg {
      background: rgba(255, 0, 0, 0.1) !important;
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-4 space-y-6">
    <!-- Header -->
    <header class="glass-card p-6">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="text-center sm:text-left">
          <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
            Chord & Scale Library
          </h1>
          <p class="text-secondary-text mt-2">Interactive Music Theory & Instrument Visualization</p>
        </div>
        
        <div class="flex items-center gap-4">
          <select id="skinSelector" class="select-modern">
            <option value="default">Default Theme</option>
            <option value="solarized">Solarized</option>
            <option value="mono">Mono</option>
            <option value="spring">Spring</option>
            <option value="summer">Summer</option>
            <option value="autumn">Autumn</option>
            <option value="winter">Winter</option>
            <option value="forest">Forest</option>
            <option value="ocean">Ocean</option>
            <option value="desert">Desert</option>
            <option value="mountain">Mountain</option>
            <option value="sunrise">Sunrise</option>
            <option value="sunset">Sunset</option>
          </select>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="space-y-6">
      <!-- Section 1: Choose What To Explore -->
      <section class="glass-card p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <span class="w-6 h-6 bg-accent-color rounded-full flex items-center justify-center text-sm font-bold">1</span>
          Choose What To Explore
        </h2>
        
        <div class="space-y-4">
          <!-- Mode Selection -->
          <div class="flex flex-wrap gap-3 items-center">
            <div class="inline-flex rounded-lg overflow-hidden border border-border-color">
              <button id="btnModeChord" class="btn-primary rounded-none">Chord</button>
              <button id="btnModeScale" class="btn-secondary rounded-none">Scale/Mode</button>
              <button id="btnModeSequencer" class="btn-secondary rounded-none">Sequencer</button>
            </div>
          </div>

          <!-- Controls Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- System -->
            <div class="space-y-2">
              <label class="text-sm font-medium text-secondary-text">System</label>
              <select id="selSystem" class="select-modern w-full"></select>
            </div>

            <!-- Key/Root -->
            <div class="space-y-2">
              <label class="text-sm font-medium text-secondary-text">Key / Root</label>
              <div class="flex items-center gap-2">
                <select id="selKey" class="select-modern flex-1"></select>
                <span id="badgeRoot" class="badge badge-success"></span>
              </div>
            </div>

            <!-- Quality (Chord Mode) -->
            <div id="wrapChord" class="space-y-2">
              <label class="text-sm font-medium text-secondary-text">Quality</label>
              <div class="flex items-center gap-2">
                <select id="selQuality" class="select-modern flex-1"></select>
                <span id="badgeChordNotes" class="badge"></span>
              </div>
            </div>

            <!-- Mode (Scale Mode) -->
            <div id="wrapScale" class="space-y-2 hidden">
              <label class="text-sm font-medium text-secondary-text">Mode</label>
              <div class="flex items-center gap-2">
                <select id="selMode" class="select-modern flex-1"></select>
                <span id="badgeScaleNotes" class="badge"></span>
              </div>
            </div>
          </div>

          <!-- Instrument & Tempo -->
          <div class="flex flex-wrap items-center gap-4 pt-2 border-t border-border-color">
            <div class="flex items-center gap-2">
              <label class="text-sm font-medium text-secondary-text">Instrument</label>
              <select id="selInstr" class="select-modern"></select>
              <img id="instrIcon" alt="" class="w-6 h-6 hidden" />
            </div>
            
            <div class="flex items-center gap-2">
              <label class="text-sm font-medium text-secondary-text">Tempo</label>
              <input id="tempo" type="number" class="select-modern w-20" value="120" />
            </div>
          </div>
        </div>
      </section>

      <!-- Section 2: Visualize On Your Instrument -->
      <section class="glass-card p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <span class="w-6 h-6 bg-accent-color rounded-full flex items-center justify-center text-sm font-bold">2</span>
          Visualize On Your Instrument
        </h2>
        
        <div class="space-y-6">
          <!-- Instrument Hosts -->
          <div id="pianoHost"></div>
          <div id="guitarHost" class="hidden"></div>
          <div id="bassHost" class="hidden"></div>
          <div id="violinHost" class="hidden"></div>
          
          <!-- Flute -->
          <div id="fluteHost" class="hidden"></div>
          <div id="fluteHost3d" class="hidden">
            <div class="instrument-3d-container">
              <canvas id="flute3dCanvas" class="instrument-3d-canvas"></canvas>
            </div>
          </div>
          
          <!-- Recorder -->
          <div id="recorderHost" class="hidden"></div>
          <div id="recorderHost3d" class="hidden">
            <div class="instrument-3d-container">
              <canvas id="recorder3dCanvas" class="instrument-3d-canvas"></canvas>
            </div>
          </div>
          
          <!-- Trumpet -->
          <div id="trumpetHost" class="hidden"></div>
          <div id="trumpetHost3d" class="hidden">
            <div class="instrument-3d-container">
              <canvas id="trumpet3dCanvas" class="instrument-3d-canvas"></canvas>
            </div>
          </div>
          
          <!-- Saxophone -->
          <div id="saxophoneHost" class="hidden"></div>
          <div id="saxophoneHost3d" class="hidden">
            <div class="instrument-3d-container">
              <canvas id="saxophone3dCanvas" class="instrument-3d-canvas"></canvas>
            </div>
          </div>
          
          <!-- Koto -->
          <div id="kotoHost" class="hidden"></div>
          
          <!-- Ney -->
          <div id="neyHost" class="hidden"></div>
          <div id="neyHost3d" class="hidden">
            <div class="instrument-3d-container">
              <canvas id="ney3dCanvas" class="instrument-3d-canvas"></canvas>
            </div>
          </div>

          <!-- Selection Info -->
          <div class="flex flex-wrap items-center gap-3 pt-4 border-t border-border-color">
            <span id="badgeId" class="badge">Selection: —</span>
            <span id="badgeSelNotes" class="badge">Notes: —</span>
            <button id="btnClearSel" class="btn-secondary text-sm">Clear Selection</button>
            <button id="btnSendToSeq" class="btn-secondary text-sm">Send to Sequencer</button>
            <span class="text-sm text-secondary-text">
              Tip: hold keys to play • <span class="font-semibold">Shift+click</span> toggles selection
            </span>
          </div>
        </div>
      </section>

      <!-- Section 3: Listen -->
      <section class="glass-card p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <span class="w-6 h-6 bg-accent-color rounded-full flex items-center justify-center text-sm font-bold">3</span>
          Listen
        </h2>
        
        <div class="space-y-4">
          <!-- Chord Mode -->
          <div id="listenChord" class="flex flex-wrap gap-3 items-center">
            <button id="btnPlayBlock" class="btn-primary">Play Chord (block)</button>
            <button id="btnPlayArp" class="btn-primary">Arpeggiate</button>
            <button id="btnPlayStrum" class="btn-primary hidden">Strum (low→high)</button>
            <div class="text-sm text-secondary-text">First click activates audio.</div>
          </div>

          <!-- Scale Mode -->
          <div id="listenScale" class="hidden flex items-center gap-3">
            <button id="btnPlayScale" class="btn-primary">Play Scale (asc.)</button>
            <div class="text-sm text-secondary-text">Plays two octaves from the tonic.</div>
          </div>

          <!-- Selection Playback -->
          <div id="listenSel" class="flex flex-wrap gap-3 items-center pt-4 border-t border-border-color">
            <button id="btnPlaySelChord" class="btn-secondary" disabled>Play Selection (chord)</button>
            <button id="btnPlaySelArp" class="btn-secondary" disabled>Play Selection (arp)</button>
          </div>

          <!-- Audio Settings -->
          <div class="flex items-center gap-2 pt-4 border-t border-border-color">
            <input id="heldSustainSnap" type="checkbox" class="h-4 w-4" checked>
            <label for="heldSustainSnap" class="text-sm text-secondary-text">Snap held note sustain to 1/16 note</label>
          </div>
        </div>
      </section>

      <!-- Sequencer Section -->
      <section id="sequencerHost" class="glass-card p-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Sequencer</h2>
        <!-- Sequencer content will be populated by JavaScript -->
      </section>

      <!-- Export Section -->
      <section class="glass-card p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <span class="w-6 h-6 bg-accent-color rounded-full flex items-center justify-center text-sm font-bold">4</span>
          Export (FL Studio)
        </h2>
        
        <div class="flex flex-wrap gap-3 items-start">
          <button id="btnCopyFL" class="btn-secondary">Copy for FL Paste (Score)</button>
          <button id="btnCopyCSV" class="btn-secondary">Copy CSV</button>
          <button id="btnMid" class="btn-secondary">Download .MID</button>
          <div class="text-sm text-secondary-text">
            Browsers often block non‑text clipboard formats. If FL's Paste is disabled after copying, use <span class="font-semibold">Download .MID</span> and drag into Piano Roll.
          </div>
        </div>
        <div id="copyStatus" class="text-sm text-secondary-text mt-2"></div>
      </section>
    </main>

    <!-- Settings Accordion -->
    <details id="settings" class="glass-card">
      <summary class="p-4 cursor-pointer flex items-center gap-2 font-semibold">
        <span class="accordion-chevron">▶</span>
        Settings
      </summary>
      <div class="p-4 border-t border-border-color">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Audio Settings -->
          <div class="space-y-4">
            <h3 class="text-lg font-semibold">Audio Settings</h3>
            
            <div class="space-y-2">
              <label class="block text-sm font-medium">Sample Quality</label>
              <select id="sampleQuality" class="select-modern w-full">
                <option value="high">High Quality (slower loading)</option>
                <option value="medium" selected>Medium Quality (balanced)</option>
                <option value="low">Low Quality (faster loading)</option>
              </select>
            </div>

            <div class="space-y-2">
              <label class="block text-sm font-medium">Reverb Amount</label>
              <div class="flex items-center gap-2">
                <input type="range" id="reverbAmount" min="0" max="100" value="15" class="flex-1">
                <span id="reverbValue" class="text-sm w-8">15%</span>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <input type="checkbox" id="enableSamples" checked class="h-4 w-4">
              <label for="enableSamples" class="text-sm">Use high-quality samples</label>
            </div>
          </div>

          <!-- Interface Settings -->
          <div class="space-y-4">
            <h3 class="text-lg font-semibold">Interface Settings</h3>
            
            <div class="space-y-2">
              <label class="block text-sm font-medium">Piano Key Size</label>
              <select id="pianoKeySize" class="select-modern w-full">
                <option value="small">Small</option>
                <option value="medium" selected>Medium</option>
                <option value="large">Large</option>
              </select>
            </div>

            <div class="flex items-center gap-2">
              <input type="checkbox" id="enableKeyLabels" checked class="h-4 w-4">
              <label for="enableKeyLabels" class="text-sm">Show note labels on keys</label>
            </div>

            <div class="flex items-center gap-2">
              <input type="checkbox" id="enableAnimations" checked class="h-4 w-4">
              <label for="enableAnimations" class="text-sm">Enable animations</label>
            </div>

            <div class="flex items-center gap-2">
              <input type="checkbox" id="useSvgModels" class="h-4 w-4">
              <label for="useSvgModels" class="text-sm">Use SVG models (humorous)</label>
            </div>

            <!-- Session Management -->
            <div class="space-y-2 pt-4 border-t border-border-color">
              <h4 class="text-sm font-semibold">Session Management</h4>
              <div class="flex gap-2">
                <button id="saveSession" class="btn-secondary text-sm">Save Session</button>
                <button id="loadSession" class="btn-secondary text-sm">Load Session</button>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="enableAutoSave" checked class="h-4 w-4">
                <label for="enableAutoSave" class="text-sm">Auto-save every 30s</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </details>

    <!-- Developer Tests -->
    <details id="devTests" class="glass-card">
      <summary class="p-4 cursor-pointer flex items-center gap-2 font-semibold">
        <span class="accordion-chevron">▶</span>
        Automated Self‑Tests (dev)
      </summary>
      <div class="p-4 border-t border-border-color">
        <div id="tests" class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"></div>
      </div>
    </details>

    <!-- Footer -->
    <footer class="text-center text-sm text-secondary-text py-6">
      © 2025 — Interactive Chord & Scale Library
    </footer>
  </div>

  <!-- Application Script -->
  <script type="module">
    // Import modules
    import { 
      buildFluteChart, 
      buildRecorderChart, 
      buildTrumpetChart, 
      buildSaxophoneChart, 
      buildNeyChart,
      SVG_FINGERINGS,
      fluteLeftToRight,
      fluteOrientation,
      recorderLeftToRight,
      recorderOrientation,
      trumpetLeftToRight,
      trumpetOrientation,
      saxophoneLeftToRight,
      saxophoneOrientation,
      neyLeftToRight,
      neyOrientation
    } from './src/instruments/svg-models.js';
    
    import {
      init3DScene,
      update3DFingering,
      cleanup3DScene,
      threeScenes,
      threeRenderers,
      threeCameras,
      threeModels,
      FINGERING_POSITIONS,
      MODEL_URLS
    } from './src/instruments/3d-models.js';

    // Application class for better organization
    class ChordScaleLibrary {
      constructor() {
        this.initialized = false;
        this.mode = 'Chord';
        this.system = 'Western';
        this.keyRoot = 'C';
        this.chordQuality = 'Maj';
        this.scaleMode = 'Ionian';
        this.instrument = 'Piano';
        this.tempo = 120;
        
        // Initialize after DOM is ready
        this.init();
      }

      async init() {
        try {
          // Wait for DOM to be ready
          if (document.readyState === 'loading') {
            await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
          }

          // Initialize core functionality
          await this.initCore();
          
          // Initialize UI
          this.initUI();
          
          // Initialize audio
          await this.initAudio();
          
          // Initialize sequencer
          this.initSequencer();
          
          // Load settings
          this.loadSettings();
          
          // Mark as initialized
          this.initialized = true;
          
          // Initial update
          this.updateAll();
          
          // Build initial piano
          this.buildInitialPiano();
          
          // Debug: Check if elements are visible
          console.log('Debug: Checking UI elements...');
          console.log('pianoHost:', document.getElementById('pianoHost'));
          console.log('selSystem:', document.getElementById('selSystem'));
          console.log('selKey:', document.getElementById('selKey'));
          console.log('selQuality:', document.getElementById('selQuality'));
          console.log('selInstr:', document.getElementById('selInstr'));
          
          console.log('Chord & Scale Library initialized successfully');
        } catch (error) {
          console.error('Failed to initialize application:', error);
          this.showError('Failed to initialize application. Please refresh the page.');
        }
      }

      async initCore() {
        // Initialize theory constants and functions
        this.initTheory();
        
        // Initialize data structures
        this.initDataStructures();
        
        // Initialize instrument modules
        this.initInstrumentModules();
      }

      initTheory() {
        // Theory constants (moved from global scope)
        this.NOTES_SHARP = [
          "C","C+","C#","C#+","D","D+","D#","D#+",
          "E","E+","F","F+","F#","F#+","G","G+",
          "G#","G#+","A","A+","A#","A#+","B","B+"
        ];
        this.PITCH_STEP = 0.5;
        this.OCTAVE = 12;
        this.ENHARMONIC_MAP = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#","E#":"F","B#":"C","Fb":"E","Cb":"B"};
        this.KEYS = ["C","C#","Db","D","D#","Eb","E","F","F#","Gb","G","G#","Ab","A","A#","Bb","B"];
        this.INSTRUMENTS = [
          "Piano", "Guitar", "Bass", "Violin", "Flute", "Recorder", 
          "Trumpet", "Saxophone", "Koto", "Oud", "Ney", "Hammond Organ"
        ];
        
        // Chord qualities and modes
        this.CHORD_QUALITIES = {
          Maj:[0,4,7], Min:[0,3,7], Dim:[0,3,6], Aug:[0,4,8],
          Sus2:[0,2,7], Sus4:[0,5,7],
          "7":[0,4,7,10], Maj7:[0,4,7,11], Min7:[0,3,7,10],
          m7b5:[0,3,6,10], Dim7:[0,3,6,9],
          "9":[0,4,7,10,14], Maj9:[0,4,7,11,14], Min9:[0,3,7,10,14],
          "11":[0,4,7,10,14,17], Maj11:[0,4,7,11,14,17], Min11:[0,3,7,10,14,17],
          "13":[0,4,7,10,14,17,21], Maj13:[0,4,7,11,14,17,21], Min13:[0,3,7,10,14,17,21],
          "7b5":[0,4,6,10], "7#5":[0,4,8,10],
          "7b9":[0,4,7,10,13], "7#9":[0,4,7,10,15],
          "7#11":[0,4,7,10,18], "7b13":[0,4,7,10,20]
        };
        
        this.MODES = {
          Ionian:[0,2,4,5,7,9,11], Dorian:[0,2,3,5,7,9,10], Phrygian:[0,1,3,5,7,8,10],
          Lydian:[0,2,4,6,7,9,11], Mixolydian:[0,2,4,5,7,9,10], Aeolian:[0,2,3,5,7,8,10],
          Locrian:[0,1,3,5,6,8,10], Harmonic:[0,2,3,5,7,8,11], Melodic:[0,2,3,5,7,9,11],
          Pentatonic:[0,2,4,7,9], Blues:[0,3,5,6,7,10], Whole:[0,2,4,6,8,10],
          Chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],
          Maqam: [
            "Maqam Rast","Maqam Bayati","Maqam Hijaz","Maqam Saba","Maqam Nahawand",
            "Maqam Kurd","Maqam Huzam","Maqam Hijazkar"
          ]
        };
        
        // Theory functions
        this.pcIndex = this.pcIndex.bind(this);
        this.pcName = this.pcName.bind(this);
        this.midiFrom = this.midiFrom.bind(this);
        this.buildScale = this.buildScale.bind(this);
        this.buildChord = this.buildChord.bind(this);
        this.makePcSet = this.makePcSet.bind(this);
        this.mod = this.mod.bind(this);
        this.chordToMidi = this.chordToMidi.bind(this);
        this.scaleToMidi = this.scaleToMidi.bind(this);
      }

      initDataStructures() {
        // Initialize data structures
        this.selection = new Set();
        this.heldNotes = new Set();
        this.undoStack = [];
        this.redoStack = [];
      }

      initInstrumentModules() {
        // Make instrument functions globally available
        window.buildFluteChart = buildFluteChart;
        window.buildRecorderChart = buildRecorderChart;
        window.buildTrumpetChart = buildTrumpetChart;
        window.buildSaxophoneChart = buildSaxophoneChart;
        window.buildNeyChart = buildNeyChart;
        window.SVG_FINGERINGS = SVG_FINGERINGS;
        window.fluteLeftToRight = fluteLeftToRight;
        window.fluteOrientation = fluteOrientation;
        window.recorderLeftToRight = recorderLeftToRight;
        window.recorderOrientation = recorderOrientation;
        window.trumpetLeftToRight = trumpetLeftToRight;
        window.trumpetOrientation = trumpetOrientation;
        window.saxophoneLeftToRight = saxophoneLeftToRight;
        window.saxophoneOrientation = saxophoneOrientation;
        window.neyLeftToRight = neyLeftToRight;
        window.neyOrientation = neyOrientation;
        window.init3DScene = init3DScene;
        window.update3DFingering = update3DFingering;
        window.cleanup3DScene = cleanup3DScene;
        window.threeScenes = threeScenes;
        window.threeRenderers = threeRenderers;
        window.threeCameras = threeCameras;
        window.threeModels = threeModels;
        window.FINGERING_POSITIONS = FINGERING_POSITIONS;
        window.MODEL_URLS = MODEL_URLS;
      }

      initUI() {
        // Initialize UI elements and event listeners
        this.initModeButtons();
        this.initSelectors();
        this.initButtons();
        this.initSettings();
        this.populateSelectors();
      }

      initModeButtons() {
        const btnModeChord = document.getElementById('btnModeChord');
        const btnModeScale = document.getElementById('btnModeScale');
        const btnModeSequencer = document.getElementById('btnModeSequencer');
        
        btnModeChord.addEventListener('click', () => this.setMode('Chord'));
        btnModeScale.addEventListener('click', () => this.setMode('Scale/Mode'));
        btnModeSequencer.addEventListener('click', () => this.setMode('Sequencer'));
      }

      initSelectors() {
        // Initialize selectors with event listeners
        const selectors = ['selSystem', 'selKey', 'selQuality', 'selMode', 'selInstr', 'tempo'];
        selectors.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener('change', (e) => this.handleSelectorChange(id, e.target.value));
          }
        });
      }

      initButtons() {
        // Initialize buttons
        const buttons = ['btnClearSel', 'btnSendToSeq', 'btnPlayBlock', 'btnPlayArp', 'btnPlayStrum', 'btnPlayScale'];
        buttons.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener('click', (e) => this.handleButtonClick(id, e));
          }
        });
      }

      initSettings() {
        // Initialize settings
        const useSvgModels = document.getElementById('useSvgModels');
        if (useSvgModels) {
          useSvgModels.addEventListener('change', (e) => {
            localStorage.setItem('useSvgModels', e.target.checked);
            this.refreshInstruments();
            this.updateAll();
          });
        }
      }

      populateSelectors() {
        // Populate selectors with options
        this.fillSelect(document.getElementById('selSystem'), ['Western', 'Maqam']);
        this.fillSelect(document.getElementById('selKey'), this.KEYS);
        this.fillSelect(document.getElementById('selQuality'), Object.keys(this.CHORD_QUALITIES));
        this.fillSelect(document.getElementById('selMode'), Object.keys(this.MODES));
        this.fillSelect(document.getElementById('selInstr'), this.INSTRUMENTS);
        
        // Set default values
        const selSystem = document.getElementById('selSystem');
        const selKey = document.getElementById('selKey');
        const selQuality = document.getElementById('selQuality');
        const selMode = document.getElementById('selMode');
        const selInstr = document.getElementById('selInstr');
        
        if (selSystem) selSystem.value = this.system;
        if (selKey) selKey.value = this.keyRoot;
        if (selQuality) selQuality.value = this.chordQuality;
        if (selMode) selMode.value = this.scaleMode;
        if (selInstr) selInstr.value = this.instrument;
        
        // Populate mode options based on system
        this.populateModeOptions();
      }

      // Initial piano build method
      buildInitialPiano() {
        const pianoHost = document.getElementById('pianoHost');
        if (pianoHost) {
          pianoHost.classList.remove('hidden');
          this.buildPiano();
        }
      }

      // Theory functions
      pcIndex(note) {
        const n = String(note).trim();
        const m = n.match(/^([A-G])([#b+-]*)/);
        if (!m) return null;
        const BASE = {C:0, D:2, E:4, F:5, G:7, A:9, B:11};
        let val = BASE[m[1]];
        for (const ch of (m[2] || "")) {
          if (ch === "#") val += 1;
          else if (ch === "b") val -= 1;
          else if (ch === "+") val += this.PITCH_STEP;
          else if (ch === "-") val -= this.PITCH_STEP;
        }
        return val;
      }

      pcName(i) {
        const norm = ((i % this.OCTAVE) + this.OCTAVE) % this.OCTAVE;
        const idx = Math.round(norm / this.PITCH_STEP) % this.NOTES_SHARP.length;
        return this.NOTES_SHARP[idx];
      }

      midiFrom(note, octave = 4) {
        const i = this.pcIndex(note);
        if (i == null) return null;
        return this.OCTAVE * (octave + 1) + i;
      }

      buildScale(tonic, modeName) {
        const rootPc = this.pcIndex(tonic);
        const pattern = this.MODES[modeName] || this.MODES.Ionian;
        if (rootPc == null) return [];
        return pattern.map(iv => this.pcName(rootPc + iv));
      }

      buildChord(root, quality) {
        const rootPc = this.pcIndex(root);
        const pattern = this.CHORD_QUALITIES[quality] || this.CHORD_QUALITIES.Maj;
        if (rootPc == null) return [];
        return pattern.map(iv => this.pcName(rootPc + iv));
      }

      makePcSet(notes) {
        return new Set(notes.map(this.pcIndex).filter(x => x != null));
      }

      mod(n, m) {
        return ((n % m) + m) % m;
      }

      chordToMidi(notes, root, baseOct = 4) {
        const rootMidi = this.midiFrom(root, baseOct);
        if (rootMidi == null) return [];
        const rootPc = this.pcIndex(root);
        if (rootPc == null) return [];
        const pcs = notes.map(this.pcIndex).filter(x => x != null);
        const ordered = pcs.map(pc => {
          let best = rootMidi - this.mod(rootPc - pc, this.OCTAVE);
          while (best < rootMidi - 5) best += this.OCTAVE;
          while (best > rootMidi + this.OCTAVE) best -= this.OCTAVE;
          return best;
        }).sort((a, b) => a - b);
        return Array.from(new Set(ordered));
      }

      scaleToMidi(scaleNotes, tonic, startOct = 4) {
        const pcs = scaleNotes.map(this.pcIndex).filter(x => x != null);
        const tonicPc = this.pcIndex(tonic);
        if (tonicPc == null) return [];
        const seq = [];
        for (let o = startOct; o <= startOct + 1; o++) {
          for (const pc of pcs) {
            seq.push(this.OCTAVE * (o + 1) + pc);
          }
        }
        const startIdx = pcs.indexOf(tonicPc);
        if (startIdx > 0) {
          const perOct = pcs.length;
          const out = [];
          for (let i = 0; i < seq.length; i += perOct) {
            const chunk = seq.slice(i, i + perOct);
            out.push(...chunk.slice(startIdx), ...chunk.slice(0, startIdx));
          }
          return out;
        }
        return seq;
      }

      // UI helper functions
      fillSelect(el, arr) {
        if (!el) return;
        el.innerHTML = arr.map(v => `<option value="${v}">${v}</option>`).join('');
      }

      setMode(mode) {
        this.mode = mode;
        
        // Update button states
        const buttons = ['btnModeChord', 'btnModeScale', 'btnModeSequencer'];
        buttons.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.className = btn.id === `btnMode${mode.replace('/', '')}` ? 'btn-primary rounded-none' : 'btn-secondary rounded-none';
          }
        });

        // Update UI visibility
        const wrapChord = document.getElementById('wrapChord');
        const wrapScale = document.getElementById('wrapScale');
        const listenChord = document.getElementById('listenChord');
        const listenScale = document.getElementById('listenScale');
        const sequencerHost = document.getElementById('sequencerHost');

        if (mode === 'Chord') {
          wrapChord.classList.remove('hidden');
          wrapScale.classList.add('hidden');
          listenChord.classList.remove('hidden');
          listenScale.classList.add('hidden');
          sequencerHost.classList.add('hidden');
        } else if (mode === 'Scale/Mode') {
          wrapScale.classList.remove('hidden');
          wrapChord.classList.add('hidden');
          listenScale.classList.remove('hidden');
          listenChord.classList.add('hidden');
          sequencerHost.classList.add('hidden');
        } else if (mode === 'Sequencer') {
          sequencerHost.classList.remove('hidden');
          wrapChord.classList.add('hidden');
          wrapScale.classList.add('hidden');
          listenChord.classList.add('hidden');
          listenScale.classList.add('hidden');
        }

        this.updateAll();
      }

      handleSelectorChange(id, value) {
        switch (id) {
          case 'selSystem':
            this.system = value;
            this.populateModeOptions();
            break;
          case 'selKey':
            this.keyRoot = value;
            break;
          case 'selQuality':
            this.chordQuality = value;
            break;
          case 'selMode':
            this.scaleMode = value;
            break;
          case 'selInstr':
            this.instrument = value;
            this.refreshInstruments();
            break;
          case 'tempo':
            this.tempo = parseInt(value);
            break;
        }
        this.updateAll();
      }

      handleButtonClick(id, event) {
        switch (id) {
          case 'btnClearSel':
            this.clearSelection();
            break;
          case 'btnSendToSeq':
            this.sendToSequencer();
            break;
          case 'btnPlayBlock':
            this.playChord();
            break;
          case 'btnPlayArp':
            this.playArpeggio();
            break;
          case 'btnPlayStrum':
            this.playStrum();
            break;
          case 'btnPlayScale':
            this.playScale();
            break;
        }
      }

      // Core application functions
      computeSelected() {
        if (this.mode === 'Chord') {
          const notes = this.buildChord(this.keyRoot, this.chordQuality);
          return { type: 'chord', notes, pcset: new Set(notes.map(this.pcIndex).filter(x => x != null)), rootPc: this.pcIndex(this.keyRoot) };
        } else {
          const notes = this.buildScale(this.keyRoot, this.scaleMode);
          return { type: 'scale', notes, pcset: new Set(notes.map(this.pcIndex).filter(x => x != null)), rootPc: this.pcIndex(this.keyRoot) };
        }
      }

      updateAll() {
        if (!this.initialized) return;
        
        this.renderHighlights();
        this.updateBadges();
        this.refreshInstruments();
      }

      renderHighlights() {
        // Remove existing highlights
        document.querySelectorAll('.key-selected').forEach(el => {
          el.classList.remove('key-selected');
        });
        
        // Add highlights for selected notes
        const { pcset } = this.computeSelected();
        document.querySelectorAll('[data-note]').forEach(el => {
          const note = el.getAttribute('data-note');
          if (pcset.has(this.pcIndex(note))) {
            el.classList.add('key-selected');
          }
        });
      }

      updateBadges() {
        const { rootPc, notes } = this.computeSelected();
        const badgeRoot = document.getElementById('badgeRoot');
        const badgeChordNotes = document.getElementById('badgeChordNotes');
        const badgeScaleNotes = document.getElementById('badgeScaleNotes');
        
        if (badgeRoot) {
          badgeRoot.textContent = this.pcName(rootPc);
        }
        
        if (this.mode === 'Chord' && badgeChordNotes) {
          badgeChordNotes.textContent = notes.join(', ');
        }
        
        if (this.mode === 'Scale/Mode' && badgeScaleNotes) {
          badgeScaleNotes.textContent = notes.join(', ');
        }
      }

      refreshInstruments() {
        const useSvg = document.getElementById('useSvgModels')?.checked || false;
        
        // Determine which instrument is selected
        const isGuitar = this.instrument.startsWith('Guitar') || this.instrument.startsWith('Oud');
        const isBass = this.instrument.startsWith('Bass');
        const isViolin = this.instrument.startsWith('Violin');
        const isFlute = this.instrument.startsWith('Flute');
        const isRecorder = this.instrument.startsWith('Recorder');
        const isTrumpet = this.instrument.startsWith('Trumpet');
        const isSaxophone = this.instrument.startsWith('Saxophone');
        const isKoto = this.instrument.startsWith('Koto');
        const isNey = this.instrument.startsWith('Ney');
        const isPiano = this.instrument === 'Piano';
        
        // Show/hide hosts
        const hosts = {
          pianoHost: isPiano,
          guitarHost: isGuitar,
          bassHost: isBass,
          violinHost: isViolin,
          fluteHost: isFlute && useSvg,
          recorderHost: isRecorder && useSvg,
          trumpetHost: isTrumpet && useSvg,
          saxophoneHost: isSaxophone && useSvg,
          kotoHost: isKoto,
          neyHost: isNey && useSvg,
          fluteHost3d: isFlute && !useSvg,
          recorderHost3d: isRecorder && !useSvg,
          trumpetHost3d: isTrumpet && !useSvg,
          saxophoneHost3d: isSaxophone && !useSvg,
          neyHost3d: isNey && !useSvg
        };

        Object.entries(hosts).forEach(([id, shouldShow]) => {
          const element = document.getElementById(id);
          if (element) {
            element.classList.toggle('hidden', !shouldShow);
          }
        });

        // Build instruments
        if (isPiano) {
          this.buildPiano();
        }
        if (isGuitar) {
          this.buildFretboard(document.getElementById('guitarHost'), ['E', 'A', 'D', 'G', 'B', 'E'], 'Guitar (6 strings)');
        }
        if (isBass) {
          this.buildFretboard(document.getElementById('bassHost'), ['E', 'A', 'D', 'G'], 'Bass (4 strings)');
        }
        if (isViolin) {
          this.buildFretboard(document.getElementById('violinHost'), ['G', 'D', 'A', 'E'], 'Violin (4 strings)');
        }
        if (isKoto) {
          this.buildKotoBoard();
        }
        
        // Build SVG instruments if using SVG mode
        if (useSvg) {
          if (isFlute) {
            const fluteHost = document.getElementById('fluteHost');
            if (fluteHost && window.buildFluteChart) {
              window.buildFluteChart();
            }
          }
          if (isRecorder) {
            const recorderHost = document.getElementById('recorderHost');
            if (recorderHost && window.buildRecorderChart) {
              window.buildRecorderChart();
            }
          }
          if (isTrumpet) {
            const trumpetHost = document.getElementById('trumpetHost');
            if (trumpetHost && window.buildTrumpetChart) {
              window.buildTrumpetChart();
            }
          }
          if (isSaxophone) {
            const saxophoneHost = document.getElementById('saxophoneHost');
            if (saxophoneHost && window.buildSaxophoneChart) {
              window.buildSaxophoneChart();
            }
          }
          if (isNey) {
            const neyHost = document.getElementById('neyHost');
            if (neyHost && window.buildNeyChart) {
              window.buildNeyChart();
            }
          }
        }

        // Initialize 3D scenes if needed
        this.init3DScenes();
      }

      async init3DScenes() {
        const useSvg = document.getElementById('useSvgModels')?.checked || false;
        if (useSvg) return;

        const instruments = [
          { name: 'flute', condition: this.instrument.startsWith('Flute') },
          { name: 'recorder', condition: this.instrument.startsWith('Recorder') },
          { name: 'trumpet', condition: this.instrument.startsWith('Trumpet') },
          { name: 'saxophone', condition: this.instrument.startsWith('Saxophone') },
          { name: 'ney', condition: this.instrument.startsWith('Ney') }
        ];

        for (const inst of instruments) {
          if (inst.condition && !threeScenes[inst.name]) {
            try {
              await init3DScene(inst.name, `${inst.name}3dCanvas`);
              const { rootPc } = this.computeSelected();
              update3DFingering(inst.name, this.pcName(rootPc));
            } catch (error) {
              console.error(`Failed to initialize ${inst.name} 3D scene:`, error);
            }
          }
        }
      }

      clearSelection() {
        this.selection.clear();
        this.updateBadges();
        this.renderHighlights();
      }

      sendToSequencer() {
        // Implementation for sending to sequencer
        console.log('Sending to sequencer...');
      }

      playChord() {
        // Implementation for playing chord
        console.log('Playing chord...');
      }

      playArpeggio() {
        // Implementation for playing arpeggio
        console.log('Playing arpeggio...');
      }

      playStrum() {
        // Implementation for playing strum
        console.log('Playing strum...');
      }

      playScale() {
        // Implementation for playing scale
        console.log('Playing scale...');
      }

      loadSettings() {
        // Load settings from localStorage
        const useSvgModels = localStorage.getItem('useSvgModels') === 'true';
        const useSvgModelsCheckbox = document.getElementById('useSvgModels');
        if (useSvgModelsCheckbox) {
          useSvgModelsCheckbox.checked = useSvgModels;
        }
      }

      showError(message) {
        // Show error message to user
        console.error(message);
        // You could implement a toast notification here
      }

      async initAudio() {
        // Initialize audio system
        console.log('Initializing audio...');
        
        // Audio environment settings
        this.ENV = {
          Piano: {a: 0.005, d: 0.3, s: 0.3, r: 1.2, osc: 'triangle', filter: {frequency: 2500, Q: 1}, maxSustain: 4},
          Guitar: {a: 0.005, d: 0.3, s: 0, r: 1.5, osc: 'sawtooth', filter: {frequency: 3500, Q: 0.9}, vibrato: {rate: 6, depth: 0.02}, maxSustain: 3},
          Bass: {a: 0.01, d: 0.3, s: 0.5, r: 0.9, osc: 'square', filter: {frequency: 800, Q: 2}, maxSustain: 3},
          Violin: {a: 0.05, d: 0.2, s: 0.8, r: 0.8, osc: 'sawtooth', vibrato: {rate: 6.5, depth: 0.08}, filter: {frequency: 4000, Q: 1.2}, maxSustain: 5},
          Flute: {a: 0.06, d: 0.15, s: 0.85, r: 0.4, osc: 'sine', vibrato: {rate: 5, depth: 0.05}, filter: {frequency: 5000, Q: 0.5}, maxSustain: 4},
          Recorder: {a: 0.06, d: 0.12, s: 0.85, r: 0.4, osc: 'sine', filter: {frequency: 3500, Q: 0.7}, maxSustain: 3}
        };
        
        this._synth = null;
        this._started = false;
      }

      initSequencer() {
        // Initialize sequencer
        console.log('Initializing sequencer...');
      }

      populateModeOptions() {
        // Populate mode options based on system
        const selMode = document.getElementById('selMode');
        if (!selMode) return;
        
        if (this.system === 'Western') {
          const westernModes = Object.keys(this.MODES).filter(key => key !== 'Maqam');
          this.fillSelect(selMode, westernModes);
        } else if (this.system === 'Maqam') {
          this.fillSelect(selMode, this.MODES.Maqam);
        }
        
        // Set default value
        selMode.value = this.system === 'Western' ? 'Ionian' : 'Maqam Rast';
      }

      // Instrument building functions
      buildPiano() {
        console.log('buildPiano called');
        const pianoHost = document.getElementById('pianoHost');
        console.log('pianoHost element:', pianoHost);
        if (!pianoHost) {
          console.error('pianoHost not found!');
          return;
        }
        
        pianoHost.innerHTML = '';
        const container = document.createElement('div');
        container.className = 'relative mx-auto select-none debug-border';
        
        const shell = document.createElement('div');
        shell.className = 'relative bg-white border-2 border-gray-800 rounded-b-lg debug-bg';
        shell.style.height = '120px';
        
        // Add white keys
        for (let i = 0; i < 13; i++) {
          const key = document.createElement('div');
          key.className = 'absolute bg-white border border-gray-300 rounded-b cursor-pointer hover:bg-gray-100 transition-colors';
          key.style.width = '40px';
          key.style.height = '120px';
          key.style.left = `${i * 40}px`;
          key.style.zIndex = '1';
          
          const note = this.pcName(i);
          key.textContent = note;
          key.style.fontSize = '12px';
          key.style.textAlign = 'center';
          key.style.paddingTop = '80px';
          key.style.color = '#333';
          
          key.addEventListener('click', (e) => this.handlePianoKeyClick(note, e));
          key.addEventListener('mousedown', (e) => this.handlePianoKeyDown(note, e));
          key.addEventListener('mouseup', (e) => this.handlePianoKeyUp(note, e));
          
          shell.appendChild(key);
        }
        
        // Add black keys
        const blackKeyPositions = [1, 2, 4, 5, 6, 8, 9, 11, 12];
        blackKeyPositions.forEach(pos => {
          const key = document.createElement('div');
          key.className = 'absolute bg-gray-800 border border-gray-900 rounded-b cursor-pointer hover:bg-gray-700 transition-colors';
          key.style.width = '24px';
          key.style.height = '80px';
          key.style.left = `${pos * 40 - 12}px`;
          key.style.zIndex = '2';
          
          const note = this.pcName(pos);
          key.textContent = note;
          key.style.fontSize = '10px';
          key.style.textAlign = 'center';
          key.style.paddingTop = '50px';
          key.style.color = 'white';
          
          key.addEventListener('click', (e) => this.handlePianoKeyClick(note, e));
          key.addEventListener('mousedown', (e) => this.handlePianoKeyDown(note, e));
          key.addEventListener('mouseup', (e) => this.handlePianoKeyUp(note, e));
          
          shell.appendChild(key);
        });
        
        container.appendChild(shell);
        pianoHost.appendChild(container);
        console.log('Piano built successfully');
      }

      buildFretboard(host, tuning, title) {
        if (!host) return;
        
        host.innerHTML = '';
        const container = document.createElement('div');
        container.className = 'space-y-2';
        
        const titleEl = document.createElement('h3');
        titleEl.className = 'text-lg font-semibold text-center';
        titleEl.textContent = title;
        container.appendChild(titleEl);
        
        const fretboard = document.createElement('div');
        fretboard.className = 'grid gap-1';
        fretboard.style.gridTemplateColumns = `repeat(${tuning.length}, 1fr)`;
        
        // Create fretboard grid
        for (let string = 0; string < tuning.length; string++) {
          for (let fret = 0; fret < 12; fret++) {
            const fretEl = document.createElement('div');
            fretEl.className = 'border border-gray-600 p-2 text-center cursor-pointer hover:bg-blue-100 transition-colors';
            fretEl.style.minHeight = '40px';
            
            const note = this.pcName(this.pcIndex(tuning[string]) + fret);
            fretEl.textContent = note;
            fretEl.style.fontSize = '12px';
            
            fretEl.addEventListener('click', (e) => this.handleFretClick(note, e));
            
            fretboard.appendChild(fretEl);
          }
        }
        
        container.appendChild(fretboard);
        host.appendChild(container);
      }

      buildKotoBoard() {
        const kotoHost = document.getElementById('kotoHost');
        if (!kotoHost) return;
        
        this.buildFretboard(kotoHost, ['D', 'G', 'A', 'B', 'D', 'G', 'A', 'B', 'D', 'G', 'A', 'B', 'D'], 'Koto (13 strings)');
      }

      // Event handlers
      handlePianoKeyClick(note, event) {
        if (event.shiftKey) {
          this.toggleSelection(note);
        } else {
          this.playNote(note);
        }
      }

      handlePianoKeyDown(note, event) {
        this.heldNotes.add(note);
        this.playNote(note);
      }

      handlePianoKeyUp(note, event) {
        this.heldNotes.delete(note);
        this.stopNote(note);
      }

      handleFretClick(note, event) {
        if (event.shiftKey) {
          this.toggleSelection(note);
        } else {
          this.playNote(note);
        }
      }

      toggleSelection(note) {
        if (this.selection.has(note)) {
          this.selection.delete(note);
        } else {
          this.selection.add(note);
        }
        this.updateSelectionBadges();
      }

      playNote(note) {
        console.log('Playing note:', note);
        // Audio implementation would go here
      }

      stopNote(note) {
        console.log('Stopping note:', note);
        // Audio implementation would go here
      }

      updateSelectionBadges() {
        const badgeId = document.getElementById('badgeId');
        const badgeSelNotes = document.getElementById('badgeSelNotes');
        
        if (badgeId) {
          badgeId.textContent = `Selection: ${this.selection.size} notes`;
        }
        
        if (badgeSelNotes) {
          const notes = Array.from(this.selection).join(', ');
          badgeSelNotes.textContent = `Notes: ${notes || '—'}`;
        }
      }
    }

    // Initialize the application
    const app = new ChordScaleLibrary();
    
    // Make app globally available for debugging
    window.app = app;
  </script>
</body>
</html>
